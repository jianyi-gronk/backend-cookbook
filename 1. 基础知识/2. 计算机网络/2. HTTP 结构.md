## 1. HTTP 结构

- 该结构在 HTTP1，HTTP2，HTTP3 中通用，应用层语义相同，只是传输方式不同

#### 1.1 HTTP 请求

- HTTP 请求由 4 个部分组成：请求行，请求头部，空行，请求体
  - 请求行
    - 请求行由 请求方法字段，URL 字段 和 HTTP 协议版本 3 个字段组成，它们用空格分隔
    - 例 GET /data/test.html HTTP/1.1
  - 请求头部
  - 空行
    - 作用是通过一个空行，告诉服务器请求头部到此为止
  - 请求体
    - 若方法字段是 GET，则此项为空，没有数据；若方法字段是 POST，则通常来说此处放置的就是要提交的数据

#### 1.2 HTTP 响应

- HTTP 响应由 4 个部分组成：状态行，响应头部，空行，响应体
  - 状态行
    - 状态行由 HTTP 协议版本 和 状态码及其描述 组成
    - 例 HTTP/1.1 200 OK
  - 响应头部
  - 空行
    - 作用是通过一个空行，告诉客户端响应头部到此为止
  - 响应体
    - 返回请求的资源，比如请求 纯数据，请求 HTML 页面，请求 JS 代码 之类，返回对应的请求的资源

## 2. 请求头部 和 响应头部

#### 2.1 请求头部

- 基础信息类
  - Host
    - 目标服务器域名和端口（ HTTP/1.1 必需 ）
    - 例如 Host: www.example.com:443
  - User-Agent
    - 客户端标识（ 浏览器/设备信息 ）
    - 例如 User-Agent: Mozilla/5.0 (Windows NT 10.0...)
  - Referer
    - 请求来源页面的
    - 例如 URL Referer: https://google.com/search?q=...
  - Accept
    - 客户端可处理的 MIME 类型及优先级
    - 例如 Accept: text/html,application/json;q=0.9
  - Accept-Language
    - 首选语言
    - 例如 Accept-Language: zh-CN,en-US;q=0.8
  - Accept-Encoding
    - 支持的压缩算法
    - 例如 Accept-Encoding: gzip, deflate, br
- 内容控制类
  - Content-Type
    - 请求体的媒体类型（ POST/PUT 必需 ）
    - 例如 Content-Type: application/json
  - Content-Length
    - 请求体字节长度
    - 例如 Content-Length: 348
  - Content-Encoding
    - 请求体使用的编码方式
    - 例如 Content-Encoding: gzip
- 缓存控制类
  - If-Modified-Since
    - 资源修改时间比对（ 配合 304 使用 ）
    - 例如 If-Modified-Since: Tue, 15 Jun 2021 08:12:31 GMT
  - If-None-Match
    - ETag 比对（ 优先级高于 If-Modified-Since ）
    - 例如 If-None-Match: "33a64df551"
- 安全认证类
  - Authorization
    - 认证凭证（ Basic/Bearer Token ）
    - 例如 Authorization: Bearer eyJhbGciOi...
  - Cookie
    - 客户端存储的 Cookie
    - 例如 Cookie: sessionId=abc123; theme=dark
- 连接控制类
  - Connection
    - 控制连接状态（ keep-alive/close ）
    - 例如 Connection: keep-alive
  - Upgrade
    - 协议升级请求（ 如 WebSocket ）
    - 例如 Upgrade: websocket

#### 2.2 响应头部

- 基础信息类
  - Server
    - 服务器软件信息
    - 例如 Server: nginx/1.18.0
  - Date
    - 响应生成时间
    - 例如 Date: Tue, 15 Jun 2021 08:12:31 GMT
  - 内容控制类
    - Content-Type
      - 响应体的媒体类型
      - 例如 Content-Type: text/html; charset=utf-8
    - Content-Length
      - 响应体字节长度
      - 例如 Content-Length: 1234
    - Content-Encoding
      - 响应体使用的编码方式
      - 例如 Content-Encoding: br
    - Content-Range
      - 部分内容范围（ 配合 206 状态码 ）
      - 例如 Content-Range: bytes 0-999/5000
- 缓存控制类
  - Cache-Control
    - 缓存策略指令
    - 例如 Cache-Control: max-age=3600, public
  - ETag
    - 资源版本标识符
    - 例如 ETag: "33a64df551425fcc55e4d42a"
  - Last-Modified
    - 资源最后修改时间
    - 例如 Last-Modified: Tue, 15 Jun 2021 07:28:00 GMT
- 重定向与位置类
  - Location
    - 重定向目标 URL（ 3xx 状态码必需 ）
    - 例如 Location: /new-page.html
  - Refresh
    - 自动刷新/重定向（ 非标准但广泛支持 ）
    - 例如 Refresh: 5; url=https://example.com
- 安全策略类
  - Set-Cookie
    - 服务器设置 Cookie
    - 例如 Set-Cookie: sessionId=abc123; HttpOnly
  - Strict-Transport-Security
    - 强制 HTTPS（ HSTS ）
    - 例如 Strict-Transport-Security: max-age=31536000
  - Content-Security-Policy
    - 内容安全策略（ 防 XSS ）
    - 例如 Content-Security-Policy: default-src 'self'
- 跨域控制类（ CORS ）
  - Access-Control-Allow-Origin
    - 允许跨域的源
    - 例如 Access-Control-Allow-Origin: \*
  - Access-Control-Allow-Methods
    - 允许的 HTTP 方法
    - 例如 Access-Control-Allow-Methods: GET, POST
  - Access-Control-Allow-Headers
    - 允许的请求头
    - 例如 Access-Control-Allow-Headers: Content-Type

## 3. 响应码

#### 3.1 常用响应码

- 1xx（ 信息性状态码 ）：**表示请求已经被接收，继续处理中**
  - 100（ Continue，继续 ）
    - 服务器收到请求，需要客户端继续发送请求
    - 对于 post，浏览器先发送 header，服务器响应 100，浏览器再发送 data，服务器响应 200
  - 101（ Switching Protocols，切换协议 ）
    - 服务器将按照客户端的要求切换协议
- 2xx（ 成功状态码 ）：表示请求已经被服务器接收、理解、并成功处理
  - 200（ OK，成功 ）
    - 表示请求已经成功处理
  - 201（ Created，已创建 ）
    - 表示请求已经被成功处理，并创建了新的资源
  - 202（ Accepted，已接受 ）
    - 服务器已接受请求，但尚未处理完成（ 常用于异步任务 ），比如需服务端长时间处理，但不想阻塞响应
  - 204（ No Content，无内容 ）
    - 表示请求已经成功处理，但是没有返回任何内容
  - 206（ Partial Content，部分内容 ）
    - 表示服务器已经成功处理了部分 GET 请求，客户端可以继续请求剩余部分的内容
    - 常用于 断点续传、大文件分片下载 等，响应头必须包含 Content-Range 字段，表示返回的内容范围
- 3xx（ 重定向状态码 ）：表示需要客户端进一步处理的状态，通常是将请求重定向到其他资源
  - 301（ Moved Permanently，永久重定向 ）
    - 请求的资源已经永久移动到新的位置，客户端应该使用新的 URL 再次请求
  - 302（ Found，临时重定向 ）
    - 请求的资源已经临时移动到新的位置，客户端应该使用新的 URL 再次请求
  - 304（ Not Modified，未修改 ）
    - 客户端发送的请求资源没有改变，服务器返回未修改状态
  - 307（ Temporary Redirect，临时重定向 ）
    - 与 302 类似，但强制要求重定向时保持原请求方法（ 如 POST 重定向后仍用 POST ）
    - 是现代浏览器替代 302 的标准做法
  - 308（ Permanent Redirect，永久重定向 ）
    - 与 301 类似，但强制要求重定向时保持原请求方法（ 如 POST 重定向后仍用 POST ）
    - 是现代浏览器替代 301 的标准做法
- 4xx（ 客户端错误状态码 ）：表示客户端发送的请求有错误，服务器无法处理
  - 400（ Bad Request，错误请求 ）
    - 请求无效，服务器无法理解
  - 401（ Unauthorized，未授权 ）
    - 客户端请求未经授权，需要身份验证
  - 403（ Forbidden，禁止访问 ）
    - 客户端请求被服务器拒绝，没有权限访问
  - 404（ Not Found，未找到 ）
    - 请求的资源不存在
  - 408（ Request Timeout，请求超时 ）
    - 服务器等待客户端发送的请求时间过长导致超时，例如 客户端上传大文件时网络中断 等
  - 413（ Payload Too Large，请求实体过大 ）
    - 请求体超过服务器限制，例如 上传超过 10MB 的文件到限制 5MB 的接口 等
  - 429（ Too Many Requests，请求过多 ）
    - 客户端在单位时间内发送了过多请求，通常出现在 防御 DDoS 攻击、API 频率限制 等场景
    - 响应头常含：Retry-After: 60，用于提示多少秒后重试
  - 451（ Unavailable For Legal Reasons，法律禁止 ）
    - 因法律要求拒绝访问，如政府内容审查
- 5xx（ 服务器错误状态码 ）：表示服务器无法完成客户端发送的请求
  - 500（ Internal Server Error，内部服务器错误 ）
    - 服务器内部错误，无法完成请求
  - 502（ Bad Gateway，错误网关 ）
    - 服务器作为网关或代理，收到无效响应
  - 503（ Service Unavailable，服务不可用 ）
    - 服务器当前无法处理请求，可能是因为过载或正在维护
  - 504（ Gateway Timeout，网关超时 ）
    - 服务器作为网关或代理，未及时收到响应
  - 507（ Insufficient Storage，存储不足 ）
    - 服务器无法完成请求（ 磁盘空间不足 ），例如云存储服务上传文件失败

#### 3.2 详细解析

- 100
  - 用于客户端在发送 POST 数据给服务器前，征询服务器情况，看服务器是否处理 POST 的数据，如果不处理，客户端则不上传 POST 数据，如果处理，则 POST 上传数据。在现实应用中，通常在 POST 大数据时，才会使用 100-continue 协议（ 所以并不是每个 post 请求都发送先发送头部 ）
  - 通过 Expect 可以设置是否使用 100-continue 协议，Expect 是一个请求头字段，包含一个期望条件，表示服务器只有在满足此期望条件的情况下才能妥善地处理请求，规范中只规定了一个期望条件，即 Expect: 100-continue
  - 客户端策略
    - 如果客户端 POST 较多数据要上传，可以考虑使用 100-continue 协议，加入头 {"Expect":"100-continue"}，这样服务器才会知道，客户端这次只发送了请求头，需要返回 100，才会继续发送真正的数据
    - 如果没有 POST 数据，不能使用 100-continue 协议，即不能加入头 {"Expect":"100-continue"}，因为这会让服务端造成误解
    - 并不是所有的服务器都会正确实现 100-continue 协议，如果客户端发送 Expect:100-continue 消息后，在 timeout 时间内无响应，Client 需要立马上传 POST 数据
  - 服务器策略
    - 正确情况下，收到请求后，返回 100 或错误码
    - 如果请求中 Content-Length 的值太大的话，即数据太多，可能会遭到服务器的拒绝
    - 如果在发送 100-continue 前收到了 POST 数据（ 客户端提前发送 POST 数据 ），则不发送 100 响应码（ 略去 ）
  - 举例
    - 比如在使用 curl 做 POST 的时候，当 POST 的数据大于 1024 字节的时候，curl 并不会直接就发起 POST 请求，而是会分为俩步，发送一个请求，包含一个 Expect:100-continue，询问 Server 使用愿意接受数据，接收到 Server 返回的 100-continue 应答以后, 才把数据 POST 给 Server
- 101
  - 比如切换成 websocket 协议就是返回 101
- 304
  - 304 虽然被划分在 3XX 中，但是和重定向没有关系，表示自上次访问以来，请求的资源未被修改，即客户端可以从自己的缓存里获取出资源
