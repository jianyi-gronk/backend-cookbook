## 1. 灰度发布

#### 基础介绍

- 指的是在同一个时间段内，存在两个不同的应用版本，一个版本叫做黑色版本，而另一个版本叫做白色版本
- 我们通过观测两个同时存在的版本的表现来调整黑色版本和白色版本的比例，如果一切顺利，渐渐地就把所有用户的应用从黑色版本过渡到白色版本。而这种通过共存黑白版本的手段进行测试的过程就叫做灰度发布
- 金丝雀发布，滚动发布，AB 测试，蓝绿发布，都属于特殊的灰度发布

#### 灰色发布流程：

- 确定自己的目标
  - 既然选用了灰度发布这个方法，就首先要确定自己的目标是什么，比如通过让一部门用户先使用产品，从而通过试用结果和用户的反馈来找出产品的不足，从而想办法来提升产品的品质，还有的除了这个目的之外可能还想要借此机会来推广自己的产品
- 选择策略
  - 定好目标之后，就要选择策略了，要根据自己产品的规模和功能的多样性来确定互联网灰度发布试用用户的规模和发布的频率，这样才可以提高用户的参与度，全方位的试用产品，这样才能反馈出一个比较全面的结果。包括用户规模、发布频率、功能覆盖度、回滚策略、运营策略、新旧系统部署策略等
- 对用户进行筛选
  - 然后就是要对这些用户进行筛选，用户的选择一定要具有代表性，要选择一部分的新用户和一部分的老用户来交替使用产品，还有就是选择的用户要具有敢问好问的精神，善于发现才能发现问题。选择完用户就是产品系统的部署，然后就是对用户参与的结果进行数据分析，找出产品存在的问题。对用户的筛选包括用户特征、用户数量、用户常用功能、用户范围等
- 部署系统
  - 部署新系统、部署用户行为分析系统（ web analytics ）、设定分流规则、运营数据分析、分流规则微调
- 发布总结
  - 用户行为分析报告、用户问卷调查、社会化媒体意见收集、形成产品功能改进列表
- 产品完善
- 新一轮灰度发布或完整发布
- 在上述步骤全都完成之后，互联网产品的灰度发布就基本上是完成了，后续最重要的事情就是全身心的投入对产品的改进中，对产品的不足进行完善，如果产品的漏洞比较大，可以进行再一轮的灰度发布，如果只是一些小问题，那么在修改之后就可以正式的发布了

## 2. 金丝雀发布

#### 基础介绍

- 矿井中的金丝雀：17 世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；当瓦斯含量超过一定限度时，虽然鲁钝的人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为瓦斯检测指标，以便在危险状况下紧急撤离
- 本质就是只试很小的范围，用来验证新功能或版本的性能和稳定性，如果通过就可以把剩下的服务器全部升级，而不是像滚动发布一样的，慢慢扩大发布范围

#### 发布流程

- 从负载均衡列表中移除掉 “金丝雀” 服务器
- 升级 “金丝雀” 应用（ 排掉原有流量并进行部署 ）
- 将 ”金丝雀“ 服务器重新添加到负载均衡列表中，从而进行连通性和健康检查
- 如果 ”金丝雀“ 在线使用测试成功，升级剩余的其他服务器，否则就回滚

#### 优势和不足

- 优势
  - 用户体验影响小，灰度发布过程出现问题只影响少量用户
- 不足
  - 发布自动化程度不够，发布期间可引发服务中断

## 3. 滚动发布

- 是一种特殊的灰度发布，自动化程度较高的发布方式，用户体验比较平滑，是目前成熟型技术组织所采用的主流发布方式，一般是取出多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本，比如 100 台机器，分 20 批更新完

#### 发布流程

- 滚动式发布一般先发一个小比例，如 2% 服务器，主要做流量验证用
- 滚动式发布需要比较复杂的发布工具和智能 LB，支持平滑的版本替换和流量拉入拉出
- 每次发布时，先将老版本流量从 LB 上摘除，然后清除老版本，发新版本，再将 LB 流量接入新版本，可以尽量保证用户体验不受影响
- 一次滚动式发布一般由若干个发布批次组成，每批的数量一般是可以配置的（ 可以通过发布模板定义 ）。例如第一批 1%（ 金丝雀 ），第二批 10%，第三批 50%，第四批 100%。每个批次之间留观察间隔，通过手工验证或监控反馈确保没有问题再发下一批次，所以总体上滚动式发布过程是比较缓慢的（ 其中金丝雀的时间一般会比后续批次更长，比如金丝雀 10 分钟，后续间隔 2 分钟 ）
- 回退是发布的逆过程，将新版本流量从 LB 上摘除，清除新版本，发老版本，再将 LB 流量接入老版本。和发布过程一样，回退过程一般也比较慢的

#### 优势和不足

- 优势
  - 用户体验影响小，体验较平滑
  - 更加节约资源，一次只需要取出少量的服务器资源
- 不足
  - 发布和回退时间比较缓慢
  - 发布工具比较复杂，LB 需要平滑的流量摘除和拉入能力

## 4. AB 测试（ 拆分运行测试 ）

#### 基础介绍

- AB 测试是一种用户体验研究方法，被广泛应用于产品开发和网站优化中。AB 测试一般由产品经理和运营来主导，它把两种或两种以上的版本，交给相同的用户来使用，看用户喜欢哪种版本，通常是通过测试受试者对变体 A 和变体 B 的反应，来确定两个变体中哪个更受用户喜欢或更有效，从而帮助优化产品、提升市场推广效果
- AB 测试是一种特殊的灰度发布，即让一部分用户继续用产品特性 A，一部分用户开始用产品特性 B，如果用户对 B 没有什么反对意见，那么逐步扩大范围，直到把所有用户都迁移到 B 上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度
- 在 AB 测试中，样本被分为两个或多个群组，每个群组被称为一个变体。其中一个变体被称为控制组（ A 组 ），其他变体被称为实验组（ B 组、C 组等 ）。这些变体可以是网站的不同页面样式设计、产品的不同功能、广告的不同文案等等
- 要点是，AB 的两种功能都是可用的， 投放的用户群体无差别，让用户选择更受欢迎的功能，后期可能是 A 上线，也可能是 B 上线
- 值得注意的是，AB 测试应该有明确的假设和预期结果，并且要确保测试的时间和样本量足够大以消除偶然因素的影响。此外，还要避免测试期间对变体进行任何其他调整，以保持测试的准确性

#### AB 测试的步骤

1. 明确目标：首先，确定测试结果的目标，例如，想测试不同页面版本的点击率、转化率或用户满意度等
2. 设计变体：根据测试目标，设计两个或多个变体。在设计时，注意只有一个变量被更改，这样才能确定变量之间的差异导致的结果
3. 随机分配：可以通过 API 网关，将用户随机分配到不同的变体中，确保每个变体都具有相似的用户属性和行为
4. 实施测试：实施 AB 测试，让不同变体的用户接触到相应的变体，并记录相关的数据指标，如页面访问量、点击率、转化率等
5. 数据分析：对收集到的数据进行统计分析，比较不同变体之间的表现。通常使用统计方法来判断差异是否具有统计显著性
6. 结果解读：根据数据分析的结果，判断哪个变体在测试指标上表现更好。如果有一个变体的效果明显优于其他变体，可以采用这个变体作为更好的选择

#### 灰度发布和 AB 测试的区别

![image](https://img-blog.csdnimg.cn/360e110188684edb9151b49bf29a34bb.png)

- 灰度发布指的是系统测试通过后，将新版本发布到线上环境，替换部分的线上服务器代码进行预测试，对新版本功能是否可用进行测试，当灰度发布结束后，线上版本实现会统一，本质上是上线前的测试，收集用户的反馈
- AB 测试指的是系统测试通过并发布后，同一个软件功能不同的用户会看到不同的实现方式，收集每个用户的反馈，分析不同样式对用户体验的影响，本质上是上线后的测试，收集用户的反馈

## 5. 蓝绿发布

#### 具体流程

![image](https://img-blog.csdnimg.cn/be5f7610c0a44771845ef33399c385c1.png)

- 先把集群分为 A，B 两部分，通过网关断开转发 A 的链路，接口全部被转发到了应用集群 B，同时开始升级 A
- 升级 A 完成后，将全部流量转发到 A，再断开 B
- 如果如集群 A 测试正常，则升级 B，升级完后，连接上 B，发布成功；若测试失败，把接口全部转发到集群 B，同时将集群 A 回退

#### 优势和不足

- 优点：
  - 升级切换和回退速度非常快
- 不足：
  - 切换是全量的，如果新版本有问题，则对用户体验有直接影响
  - 升级过程中由于节点数量减半，导致节点压力骤增，因此对发布时机有一定限制，通常会选择在夜间发布

## 6. 功能开关发布

#### 基础介绍

- 利用代码中的功能开关（ Feature Flag / Toggle / Switch ）来控制发布逻辑，一般不需要复杂的发布工具和智能 LB 配合，是一种相对比较低成本和简单的发布方式。这种方式也是支持现代 DevOps 理念，研发人员可以灵活定制和自助完成的发布方式
- 功能开关的原理如下图所示（ 本质就是很简单的 if...else... 语句，if 和 else 后分别是不同版本的逻辑，flag 来控制目前版本 ）：
  ![image](https://img-blog.csdnimg.cn/d6f2ca15554740b19490f480f01c09d4.png)

#### 部署过程

- 功能开关发布需要一个配置中心或者开关中心这样的服务支持，例如携程的 Apollo 配置中心或者开源的 FF4J，这些都支持开关发布，业界还有专门的功能开关 SaaS 服务，例如 LaunchDarkly
- 通过配置中心，运维或研发人员可以在运行期动态配置功能开关的值
- 当然，功能开关发布只是配置中心的一种使用场景，配置中心还能支持其它很多动态配置场景
- 功能开关服务一般提供客户端 SDK，方便开发人员集成。在运行期，客户端 SDK 会同步最新的开关值，技术实现有推方式 ( push )，也有拉方式 ( pull )，或者推拉结合方式
- 新功能（ V2 new feature ）和老功能（ V1 old feature ）住在同一套代码中，新功能隐藏在开关后面，如果开关没有打开，则走老代码逻辑，如果开关打开，则走新代码逻辑，技术实现上可以理解为一个简单的 if/else 逻辑
- 应用上线后，开关先不打开，然后运维或研发人员通过开关中心打开新功能，经过流量验证新功能没有问题，则发布完成；如果有问题，则随时可以通过开关中心切回老功能逻辑

#### 慢切开关

- 如果怕一次把全部开关打开，出现 bug 的风险太大，也可以做类似灰度的策略，比如尾号为 1 的用户才能走新版本的逻辑，然后在慢慢放开条件判断的范围

#### 优势和不足

- 优势
  - 升级切换和回退速度非常快
  - 相对于复杂的发布工具，实施比较简单，成本相对低廉
  - 研发能够灵活定制发布逻辑，支持 DevOps 自助发布
- 不足
  - 切换是全量的，如果 V2 版本有问题，则对用户体验有直接影响
  - 对代码有侵入，代码逻辑会变复杂，需要定期清理老版本逻辑，维护成本变高
