## 1. 基础概念

- Apache Storm 是一个开源的分布式实时计算系统，可以简单、高效、可靠地处理流数据，并支持多种编程语言
- 使用场景：实时分析、在线机器学习、持续的计算、分布式 RPC、ETL 等等

#### 1.1 Storm 基础结构

- Storm 结构称为 topology（ 拓扑 ），由 stream（ 数据流 ）、spout（ 数据流的生成者 ）、bolt（ 数据流的运算者 ）组成
  ![image](https://github.com/user-attachments/assets/01ee5ee4-4408-46dd-b4e3-ffe58758c717)

#### 1.2 元组 和 流

- Tuple（ 元组 ）
  - Storm 将流中元素抽象为 Tuple，可以理解为 Storm 这个流中的数据
- Stream（ 流 ）
  - 由 tuple 组成的无序序列，也可以理解为数据流
  - 数据流从 Spouts 流到 Bolts，或从一个 Bolt 流到另一个 Bolt

#### 1.3 数据源头（ Spout ）

- 是流数据的数据源头，负责从外部源（ 如消息队列，文件系统等 ）读入流数据，并将数据封装成 Tuple 发送到流里
- Spout 通常只负责转换数据、发射数据，不会用于处理业务逻辑，防止与业务产生耦合，从而可以很方便的实现 Spout 的复用
- 开发一个 Spout 的主要工作就是利用 API 编写代码从数据源消费数据流
- Spout 的数据源可以有很多种来源：Web 或者移动程序的点击、社交网络的信息、传感器收集到的数据、应用程序产生的日志信息

#### 1.4 处理单元（ Bolt ）

- Bolt 主要负责数据的运算，表示拓扑中具有最小处理逻辑的节点。将接收到的数据实施运算后，选择性的输出一个或多个数据流
- Bolt 常见的典型功能有：过滤、连接、聚合、计算和数据库的读写
- Bolt 可以接收多个由 Spout 或上游 Bolt 发射的数据流，处理完数据后，将结果输出到终端或下游 Blot，从而可以组建出复杂的数据转换和处理的网络拓扑结构

#### 1.5 拓扑（ Topologies ）

- **一个 Topology 是由一组 Spout 组件和一组 Bolt 组件通过 Stream Groupings 进行连接的有向无环图**
- 业务处理逻辑被封装进 Topology 中。Topology 里面的每个处理组件（ Spout 或 Bolt ）都包含处理逻辑，而组件之间的连接则表示数据流动的方向
- Topology 里面的每一个组件都是并行运行的：
  - 在 Topology 里面可以指定每个组件的并行度，Storm 会在集群里面分配那么多的线程来同时计算
  - 在 Topology 的具体实现上，Storm 中的 Topology 定义仅仅是一些 Thrift 结构体（ 二进制高性能的通信中间件 ），支持各种编程语言进行定义
- 拓扑从 Spouts 开始，Spouts 将数据发射到一个或 多个 Bolts。并且 Storm 保持拓扑始终运行，直到手动终止拓扑

#### 1.6 举例

- Storm 就像一个加工厂，原材料厂家（ Spout ）负责配送原材料（ Tuple ），确保加工厂有持续的原料供应
- 原材料进入之后，会经过一个个不同机床（ Bolt ）进行串行和并行的处理，最终得到加工完成的产品（ 处理结果 ）
- 在这个加工过程中，管理员（ Topologies ）定义了材料变成产品的加工路径，即原材料如何从一个机床流向另一个机床

## 2. 流分组（ Stream groupings ）

- 流分组控制元组在拓扑中的路由方式，在当前版本中常用有 8 种流分组（ 另外也可以自定义 ）
  - Shuffle grouping：随机分组，随机分发 Stream 中的 Tuple，保证每个 Bolt 的 Task 接收 Tuple 数量大致一致
  - Fields grouping：按照字段分组，保证相同字段的 Tuple 分配到同一个 Task 中
  - Partial Key grouping：带负载均衡的按字段分组
  - All grouping：广播发送，每一个 Task 都会收到所有的 Tuple
  - Global grouping：全局分组，所有的 Tuple 都发送到同一个 Task 中
  - None grouping：不分组，和 ShuffleGrouping 类似，当前 Task 的执行会和它的被订阅者在同一个线程中执行
  - Direct grouping：直接分组，直接指定由某个 Task 来执行 Tuple 的处理
  - Local or shuffle grouping：若目标 Bolt 有多个 worker 进程，会发送给这些进程 的 Tasks，否则执行 Shuffle grouping

## 3. 集群架构

#### 3.1 架构节点

- 简易流程图如下
  ![image](https://github.com/user-attachments/assets/3f4e7c2b-fff1-4b4a-b89f-949bbf428859)
- Nimbus（ 主节点 ）
  - Nimbus 是 Storm 集群的主节点
  - Nimbus 的作用在就是在拓扑任务开始阶段，负责将任务提交到集群，后期负责拓扑任务的管理，比如任务查看，终止等操作
- Supervisor（ 工作节点 ）
  - 执行指令的节点被称为 Supervisors
  - Supervisor 有多个工作进程，它管理工作进程以完成由 nimbus 分配的任务
- Worker process（ 工作进程 ）
  - 工作进程将执行与特定拓扑相关的任务。工作进程不会自己运行任务，而是创建执行器并要求他们执行特定的任务。工作进程将有多个执行器

#### 3.2 框架设计

- Storm 集群采用 “Master—Worker” 的节点方式
  ![image](https://github.com/user-attachments/assets/a71b8581-e6b8-463c-99ed-115581594d6f)
  - Master 节点运行 Nimbus
  - Worker 节点运行 Supervisor
  - 使用 Zookeeper 来作为分布式协调组件，负责 Nimbus 和多个 Supervisor 之间的所有协调工作。借助于 Zookeeper，若 Nimbus 进程或 Supervisor 进程意外终止，重启时也能读取、恢复之前的状态并继续工作，使得 Storm 极其稳定

#### 3.3 详细工作流程

![image](https://github.com/user-attachments/assets/647e5754-6e5f-4475-a9ae-9b38700a65d3)

## 4. 并发级别

- Storm 集群中的 topology 在如下的四个级别中存在并发
- Nodes，即服务器：
  - 配置在 Storm 集群中的一个服务器，会执行 Topology 的一部分运算，一个 Storm 集群中包含一个或者多个 Node
- Workers，即 JVM 虚拟机、进程：
  - 指一个 Node 上相互独立运作的 JVM 进程，每个 Node 可以配置运行一个或多个 worker。一个 Topology 会分配到一个或者多个 worker 上运行
- Executor，即线程
  - 指一个 worker 的 jvm 中运行的 java 线程。多个 task 可以指派给同一个 executer 来执行。除非是明确指定，Storm 默认会给每个 executor 分配一个 task
- Task，即 spout 或 bolt 实例：
  - task 是 spout 或 bolt 的实例，他们的 nextTuple()和 execute()方法会被 executors 线程调用执行
- 大多数情况下，除非明确指定，Storm 的默认并发设置值是 1。即，一台服务器（ node ），为 topology 分配一个 worker，每个 executer 执行一个 task
  ![image](https://github.com/user-attachments/assets/f33b29d8-0c16-4036-ad99-b2fb10395675)

## 5. 消息保证机制

- 消息保证机制依赖于消息是否被完全处理，Storm 提供了三种不同层次的消息保证机制，分别是
  - 最多一次（ At Most Once ）：不需要特殊处理实现
  - 最少一次（ At Least Once ）：通过 ACK 机制实现
  - 精确一次（ Exactly Once ）：通过 Trident 实现
