## 1. 元数据中心

- 注意，Metadata Service（ 元数据服务 ）和 Metadata Center（ 元数据中心 ）不是一个东西
- 元数据中心为 Dubbo 中的两类元数据提供了存取能力
  - 地址发现元数据
  - 服务运维元数据

## 2. 地址发现元数据

#### 2.1 背景

- Dubbo3 中引入了 应用级服务发现机制 用来解决异构微服务体系互通与大规模集群实践的性能问题，应用级服务发现将全面取代 2.x 时代的接口级服务发现
- 同时为了保持 Dubbo 面向服务/接口的易用性、服务治理的灵活性，Dubbo 围绕应用级服务发现构建了一套元数据机制，即 接口 - 应用映射关系 与 接口配置元数据

## 2.2 作用概括

- 元数据中心来维护 RPC 服务与应用的映射关系（ 即接口与应用的映射关系 ）来兼容接口与应用之间的对应关系
- 让注册中心更加聚焦与地址的发现和推送能力
- **与配置中心相反，从用户视角来看元数据中心是只读的**，元数据中心唯一的写入方是 Dubbo 进程实例，Dubbo 实例会在启动之后将一些内部状态（ 如服务列表、服务配置、服务定义格式等 ）上报到元数据中心，供一些治理能力作为数据来源，如服务测试、文档管理、服务状态展示等
- Dubbo 官方支持 Zookeeper、Nacos、Etcd、Redis 等元数据中心实现

## 2.3 适用场景

- 元数据中心在 Dubbo 2.7.x 版本开始支持，随着应用级别的服务注册和服务发现在 Dubbo 中落地，元数据中心也变的越来越重要。如果有以下两种需求，都可以选择部署元数据中心，并通过 Dubbo 的配置来集成该元数据中心
- 需求一：**对于一个原先采用老版本 Dubbo 搭建的应用服务，需要迁移 Dubbo3**
  - 在迁移到 Dubbo 3 时，Dubbo 3 会需要一个元数据中心来维护 RPC 服务与应用的映射关系，即接口与应用的映射关系
  - 因为如果采用了应用级别的服务发现和服务注册，在注册中心中将采用 “应用 —— 实例列表” 结构的数据组织形式，不再是以往的 “接口 —— 实例列表” 结构的数据组织形式
  - 而以往用接口级别的服务注册和服务发现的应用服务在迁移到应用级别时，得不到接口与应用之间的对应关系，从而无法从注册中心得到实例列表信息
  - 所以 Dubbo 为了兼容这种场景，在 Provider 端启动时，会往元数据中心存储接口与应用的映射关系
- 需求二：**为了让注册中心更加聚焦与地址的发现和推送能力，减轻注册中心的负担**
  - 元数据中心承载了所有的服务元数据、大量接口/方法级别配置信息等，无论是接口粒度还是应用粒度的服务发现和注册，元数据中心都起到了重要的作用
- **元数据中心并不依赖于注册中心和配置中心，用户可以自由选择是否集成和部署元数据中心**，如下图所示
  ![image](https://github.com/user-attachments/assets/1ae09e5e-db83-46cc-acfb-bcec3c96df72)
  - 该图中不配备配置中心，意味着可以不需要全局管理配置的能力。该图中不配备注册中心，意味着可能采用了 Dubbo mesh 的方案，也可能不需要进行服务注册，仅仅接收直连模式的服务调用

#### 2.4 接口 - 应用映射关系

- Dubbo2 一直以来都能做到精确的地址发现，即只订阅 Consumer 声明要关心的服务及相关的地址列表，相比于拉取/订阅全量地址列表，这样做有很好的性能优势
- 但是在应用级服务发现模型中，想做到精确地址订阅并不容易，因为 Dubbo Consumer 只声明了要消费的接口列表，Consumer 需要能够将接口转换为 Provider 应用名才能进行精准服务订阅
- 为此，Dubbo 需要在元数据中心维护这一份 接口名->应用名 的对应关系，Dubbo3 中通过 provider 启动的时候主动向元数据中心上报实现
- 接口 - 应用 的映射关系可以是一对多的，即一个 service name 可能会对应多个不同的 application name
- 以 zookeeper 为例，映射关系保存在以下位置
  ```
  $ ./zkCli.sh
  $ get /dubbo/mapping/org.apache.dubbo.demo.DemoService
  $ demo-provider,two-demo-provider,dubbo-demo-annotation-provider
  ```
  - 节点路径是 /dubbo/mapping/{interface name}
  - 多个应用名通过英文逗号 , 隔开

#### 2.5 接口配置元数据

- 接口级配置元数据是作为地址发现的补充，相比于 Spring Cloud 等地址发现模型只能同步 ip、port 信息，Dubbo 的服务发现机制可以同步接口列表、接口定义、接口级参数配置等信息
- 这部分内容根据当前应用的自身信息、以及接口信息计算而来，并且从性能角度出发，还根据元数据生成 revision，以实现不同机器实例间的元数据聚合
- 以 Zookeeper 为例，接口配置元数据保存在以下位置，如果多个实例生成的 revision 相同，则最终会共享同一份元数据配置：/dubbo/metadata/{application name}/{revision}

  ```
  [zk: localhost:2181(CONNECTED) 33] get /dubbo/metadata/demo-provider/da3be833baa2088c5f6776fb7ab1a436

  {
    "app":"demo-provider",
    "revision":"da3be833baa2088c5f6776fb7ab1a436",
    "services":{
        "org.apache.dubbo.demo.DemoService:dubbo":{
            "name":"org.apache.dubbo.demo.DemoService",
            "protocol":"dubbo",
            "path":"org.apache.dubbo.demo.DemoService",
            "params":{
                "side":"provider",
                "release":"",
                "methods":"sayHello,sayHelloAsync",
                "deprecated":"false",
                "dubbo":"2.0.2",
                "pid":"38298",
                "interface":"org.apache.dubbo.demo.DemoService",
                "service-name-mapping":"true",
                "timeout":"3000",
                "generic":"false",
                "metadata-type":"remote",
                "delay":"5000",
                "application":"demo-provider",
                "dynamic":"true",
                "REGISTRY_CLUSTER":"registry1",
                "anyhost":"true",
                "timestamp":"1626887121829"
            }
        },
        "org.apache.dubbo.demo.RestDemoService:1.0.0:rest":{
            "name":"org.apache.dubbo.demo.RestDemoService",
            "version":"1.0.0",
            "protocol":"rest",
            "path":"org.apache.dubbo.demo.RestDemoService",
            "params":{
                "side":"provider",
                "release":"",
                "methods":"getRemoteApplicationName,sayHello,hello,error",
                "deprecated":"false",
                "dubbo":"2.0.2",
                "pid":"38298",
                "interface":"org.apache.dubbo.demo.RestDemoService",
                "service-name-mapping":"true",
                "version":"1.0.0",
                "timeout":"5000",
                "generic":"false",
                "revision":"1.0.0",
                "metadata-type":"remote",
                "delay":"5000",
                "application":"demo-provider",
                "dynamic":"true",
                "REGISTRY_CLUSTER":"registry1",
                "anyhost":"true",
                "timestamp":"1626887120943"
            }
        }
    }
  }
  ```

## 3. 服务运维元数据

- Dubbo 上报的服务运维元数据通常为各种运维系统所用，如服务测试、网关数据映射、服务静态依赖关系分析等，各种第三方系统可直接读取并使用这部分数据
- Provider 上报的元数据
  ```
  {
    "parameters": {
      "side": "provider",
      "methods": "sayHello",
      "dubbo": "2.0.2",
      "threads": "100",
      "interface": "org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService",
      "threadpool": "fixed",
      "version": "1.1.1",
      "generic": "false",
      "revision": "1.1.1",
      "valid": "true",
      "application": "metadatareport-configcenter-provider",
      "default.timeout": "5000",
      "group": "d-test",
      "anyhost": "true"
    },
    "canonicalName": "org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService",
    "codeSource": "file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter/target/classes/",
    "methods": [{
      "name": "sayHello",
      "parameterTypes": ["java.lang.String"],
      "returnType": "java.lang.String"
    }],
    "types": [{
      "type": "java.lang.String",
      "properties": {
        "value": {
          "type": "char[]"
        },
        "hash": {
          "type": "int"
        }
      }
    }, {
      "type": "int"
    }, {
      "type": "char"
    }]
  }
  ```
- Consumer 上报的元数据
  ```
  {
    "valid": "true",
    "side": "consumer",
    "application": "metadatareport-configcenter-consumer",
    "methods": "sayHello",
    "default.timeout": "6666",
    "dubbo": "2.0.2",
    "interface": "org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService",
    "version": "1.1.1",
    "revision": "1.1.1",
    "group": "d-test"
  }
  ```

## 4. 元数据上报工作机制

- 元数据上报默认是一个异步的过程，为了更好的控制异步行为，元数据配置组件开放了两个配置项：
  - 失败重试
    - 失败重试可以通过 retrytimes （ 重试次数，默认 100 ），retryperiod（ 重试周期。默认 3000ms ）进行设置
  - 定时重试刷新
    - 默认开启，可以通过设置 cycleReport=false 进行关闭
- 完整配置

  ```
  dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
  dubbo.metadata-report.username=xxx         ##非必须
  dubbo.metadata-report.password=xxx         ##非必须
  dubbo.metadata-report.retry-times=30       ##非必须,default值100
  dubbo.metadata-report.retry-period=5000    ##非必须,default值3000
  dubbo.metadata-report.cycle-report=false   ##非必须,default值true
  dubbo.metadata-report.sync.report=false    ##非必须,default值为false

  # 如果元数据地址（ dubbo.metadata-report.address ）也不进行配置，会判断注册中心的协议是否支持元数据中心，如果支持，会使用注册中心的地址来用作元数据中心
  ```

## 5. 常用配置项

- 可配置项如下，对应类型为 MetadataReportConfig
  ![image](https://github.com/user-attachments/assets/976eedf1-5ee3-4c41-8a28-eaeb2e96a102)
