## 1. 什么是 Nacos

[参考资料](https://nacos.io/docs/ebook/kbyo6n/)

#### 1.1 基础介绍

- Nacos 是 Dynamic Naming and Configuration Service 的首字母简称，是阿里巴巴推出来的一个开源项目
- Nacos 是一个更易于构建云原生应用的 动态服务发现、配置管理 和 服务管理平台，能更敏捷和容易地构建、交付和管理微服务平台
- Nacos 是构建以 “服务” 为中心的现代应用架构（ 例如 微服务范式、云原生范式 ）的服务基础设施

#### 1.2 语言生态

- Nacos 几乎支持所有主流语言，其中 Java/Golang/Python 已经支持 Nacos 2.0 长链接协议，能最大限度发挥 Nacos 性能
- 阿里微服务 DNS（ Dubbo + Nacos + Spring-cloud-alibaba/Seata/Sentinel ）最佳实践，是 Java 微服务生态最佳解决方案
- 除此之外，Nacos 也对微服务生态活跃的技术做了无缝的支持，如目前比较流行的 Envoy、Dapr 等，能让用户更加标准获取微服务能力

## 2.架构介绍

- 整体架构分为用户层、业务层、内核层和插件，用户层主要解决用户使用的易用性问题，业务层主要解决服务发现和配置管理的功能问题，内核层解决分布式系统一致性、存储、高可用等核心问题，插件解决扩展性问题
  ![image](https://github.com/user-attachments/assets/dd95f8b3-1a78-4bf2-ad2b-9a9b7696fdf8)

#### 2.1 用户层

- OpenAPI：暴露标准 Rest 风格 HTTP 接口，简单易用，方便多语言集成
- Console：易用控制台，做服务管理、配置管理等操作
- SDK：多语言 SDK，目前几乎支持所有主流编程语言
- Agent：Sidecar 模式运行，通过标准 DNS 协议与业务解耦
- CLI：命令行对产品进行轻量化管理，像 git 一样好用

#### 2.2 业务层

- 服务管理：实现服务 CRUD，域名 CRUD，服务健康状态检查，服务权重管理等功能
- 配置管理：实现配置管理 CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能
- 元数据管理：提供元数据 CURD 和打标能力，为实现上层流量和服务灰度非常关键

#### 2.3 内核层

- 插件机制：实现三个模块可分可合能力，实现扩展点 SPI 机制，用于扩展自己公司定制
- 事件机制：实现异步化事件通知，SDK 数据变化异步通知等逻辑，是 Nacos 高性能的关键部分
- 日志模块：管理日志分类，日志级别，日志可移植性（ 尤其避免冲突 ），日志格式，异常码+帮助文档
- 回调机制：SDK 通知数据，通过统一的模式回调用户处理。接口和数据结构需要具备可扩展性
- 寻址模式：解决 Server IP 直连，域名访问，Nameserver 寻址、广播等多种寻址模式，需要可扩展
- 推送通道：解决 Server 与存储、Server 间、Server 与 SDK 间高效通信问题
- 容量管理：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性
- 流量管理：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制
- 缓存机制：容灾目录，本地缓存，Server 缓存机制，是 Nacos 高可用的关键
- 启动模式：按照单机模式，配置模式，服务模式，DNS 模式，启动不同的模块
- 一致性协议：解决不同数据，不同一致性要求情况下（ 包括 AP 协议和 CP 协议 ）的诉求
- 存储模块：解决数据持久化、非持久化存储，解决数据分片问题

#### 2.4 插件

- Nameserver：解决 Namespace 到 ClusterID 的路由问题，解决用户环境与 Nacos 物理环境映射问题
- CMDB：解决元数据存储，与三方 CMDB 系统对接问题，解决应用，人，资源关系
- Metrics：暴露标准 Metrics 数据，方便与三方监控系统打通
- Trace：暴露标准 Trace，方便与 SLA 系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通
- 接入管理：相当于阿里云开通服务，分配身份、容量、权限过程
- 用户管理：解决用户管理，登录，SSO 等问题
- 权限管理：解决身份识别，访问控制，角色管理等问题
- 审计系统：扩展接口方便与不同公司审计系统打通
- 通知系统：核心数据变更，或者操作，方便通过 SMS 系统打通，通知到对应人数据变更

## 3. 常用功能

#### 3.1 服务发现与服务健康监测

- Nacos 支持基于 DNS 和基于 RPC 的服务发现。服务提供者使用 原生 SDK、OpenAPI、或一个独立的 Agent TODO 注册 Service 后，服务消费者可以使用 DNS TODO 或 HTTP & API 查找和发现服务
- Nacos 提供对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求
- Nacos 支持传输层（ PING 或 TCP ）和应用层（ 如 HTTP、MySQL、用户自定义 ）的健康检查
- 对于复杂的云环境和网络拓扑环境中（ 如 VPC、边缘网络 等 ）服务的健康检查，Nacos 提供了 agent 上报模式和服务端主动检测 2 种健康检查模式。Nacos 还提供了统一的健康检查仪表盘，帮助根据健康状态管理服务的可用性及流量

#### 3.2 动态配置服务

- 动态配置服务可以让用户以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置
- 动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效和敏捷
- 配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易
- Nacos 提供了一个简洁易用的 UI（ 控制台样例 Demo ）帮助管理所有的服务和应用的配置
- Nacos 还提供包括配置版本跟踪、金丝雀发布、一键回滚配置以及客户端配置更新状态跟踪在内的一系列开箱即用的配置管理特性，帮助更安全地在生产环境中管理配置变更和降低配置变更带来的风险

#### 3.3 动态 DNS 服务

- 动态 DNS 服务支持权重路由，能更容易地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单 DNS 解析服务
- 动态 DNS 服务还能更容易地实现以 DNS 协议为基础的服务发现，以帮助消除耦合到厂商私有服务发现 API 上的风险
- Nacos 提供了一些简单的 DNS APIs TODO 帮助管理服务的关联域名和可用的 IP: PORT 列表

#### 3.4 服务及其元数据管理

- Nacos 能从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据

## 4. Nacos 一致性协议

- Nacos 虽然融 注册中心 和 配置中心 为一体，但实际是两套独立代码实现
- Nacos 是一个需要存储数据的一个组件，在集群模式下，就需要考虑如何保障各个节点之间的数据一致性以及数据同步，而要解决这个问题，就不得不引入共识算法，通过算法来保障各个节点之间的数据的一致性
- **Nacos 会在单个集群中同时运行 CP 协议以及 AP 协议**，因为 Nacos 是一个集服务注册发现以及配置管理于一体的组件。因此对于集群下，各个节点之间的数据一致性保障问题，需要拆分成两个方面，服务注册发现方面和配置管理方面

#### 4.1 从服务注册发现来看（ 非持久化存储 ）

- 非持久化服务，即需要客户端上报心跳进行服务实例续约
- 服务发现注册中心，在当前微服务体系下，是十分重要的组件，服务之间感知对方服务的当前可正常提供服务的实例信息，必须从服务发现注册中心进行获取，因此**对于服务注册发现中心组件的可用性，提出了很高的要求**，需要在任何场景下，尽最大可能保证服务注册发现能力可以对外提供服务；同时 Nacos 的服务注册发现设计，采取了心跳可自动完成服务数据补偿的机制。如果数据丢失的话，是可以通过该机制快速弥补数据丢失
- 因此，为了满足服务发现注册中心的可用性，强一致性的共识算法这里就不太合适了，因为强一致性共识算法能否对外提供服务是有要求的，如果当前集群可用的节点数没有过半的话，整个算法直接“罢工”，而最终一致共识算法的话，更多保障服务的可用性，并且能够保证在一定的时间内各个节点之间的数据能够达成一致

#### 4.2 从服务注册发现来看（ 持久化存储 ）

- 对于 Nacos 服务发现注册中的持久化服务，因为所有的数据都是直接使用调用 Nacos 服务端直接创建，因此需要由 Nacos 保障数据在各个节点之间的强一致性，故而针对此类型的服务数据，选择了强一致性共识算法来保障数据的一致性

#### 4.3 从配置管理来看

- 配置数据，是直接在 Nacos 服务端进行创建并进行管理的，必须保证大部分的节点都保存了此配置数据才能认为配置被成功保存了，否则就会丢失配置的变更，如果出现这种情况，问题是很严重的
- 如果是发布重要配置变更出现了丢失变更动作的情况，那多半就要引起严重的现网故障了，因此对于配置数据的管理，是必须要求集群中大部分的节点是强一致的，而这里的话只能使用强一致性共识算法

#### 4.4 选择 Raft

- 对于强一致性共识算法，当前工业生产中，最多使用的就是 Raft 协议
- Raft 协议更容易让人理解，并且有很多成熟的工业算法实现，比如蚂蚁金服的 JRaft、Zookeeper 的 ZAB、Consul 的 Raft、百度的 braft、Apache Ratis
- 因为 Nacos 是 Java 技术栈，因此只能在 JRaft、ZAB、Apache Ratis 中选择，但是 ZAB 因为和 Zookeeper 强绑定，再加上希望可以和 Raft 算法库的支持团队随时沟通交流，因此选择了 JRaft，选择 JRaft 也是因为 JRaft 支持多 RaftGroup，为 Nacos 后面的多数据分片带来了可能

#### 4.5 选择 Distro

- Distro 协议是阿里巴巴自研的一个最终一致性协议，最终一致性协议有很多，比如 Gossip、Eureka 内的数据同步算法
- 而 Distro 算法是集 Gossip 以及 Eureka 协议的优点并加以优化而出来的，对于原生的 Gossip，由于随机选取发送消息的节点，也就不可避免的存在消息重复发送给同一节点的情况，增加了网络的传输的压力，也给消息节点带来额外的处理负载，而 Distro 算法引入了权威 Server 的概念，每个节点负责一部分数据以及将自己的数据同步给其他节点，有效的降低了消息冗余的问题

#### 4.6 早期的 Nacos 一致性协议

- 早期的 Naocs 版本的架构
  ![image](https://github.com/user-attachments/assets/af7a9a0c-93a7-4c5a-95e7-05cf06264fc7)
- 在早期的 Nacos 架构中，服务注册和配置管理一致性协议是分开的，没有下沉到 Nacos 的内核模块作为通用能力演进，服务发现模块一致性协议的实现和服务注册发现模块的逻辑强耦合在一起，并且充斥着服务注册发现的一些概念
- 这使得 Nacos 的服务注册发现模块的逻辑变得复杂且难以维护，耦合了一致性协议层的数据状态，难以做到计算存储彻底分离，以及对计算层的无限水平扩容能力也有一定的影响
- 因此为了解决这个问题，必然需要对 Nacos 的一致性协议做抽象以及下沉，使其成为 Core 模块的能力，彻底让服务注册发现模块只充当计算能力，同时为配置模块去外部数据库存储打下了架构基础

#### 4.7 当前 Nacos 的一致性协议层

- 当前 Nacos 的架构
  ![image](https://github.com/user-attachments/assets/4e3023f7-6dd1-4638-9e4a-2a42148b87b3)
- 在新的 Nacos 架构中，已经完成了将一致性协议从原先的服务注册发现模块下沉到了内核模块当中，并且尽可能的提供了统一的抽象接口，使得上层的服务注册发现模块以及配置管理模块，不再需要耦合任何一致性语义，解耦抽象分层后，每个模块能快速演进，并且性能和可用性都大幅提升

## 5. 和其他相似技术比较

![image](https://i-blog.csdnimg.cn/blog_migrate/1c06b7f962583cfd348a9c96a4bf7d78.png)

## 6. 和 ZooKeeper 详细对比

- **ZooKeeper 更注重 分布式协调 和 一致性 等 传统的分布式场景**
- **Nacos 则专注于 服务注册和发现、配置管理 等 微服务架构和云原生场景**

#### 6.1 设计理念和用途

- ZooKeeper：
  - Zookeeper 最初是为 Hadoop 的分布式协调而设计，是一个高性能的分布式协调服务，主要用于解决分布式系统中的一致性和协调问题，它更适合于传统的分布式系统场景，通常与其他分布式系统（ 如 Hadoop、Kafka 和 HBase ）配合使用
  - 主要用于服务注册和发现、配置管理、分布式锁、分布式队列等功能。它提供可靠的数据存储和监听功能，用于处理分布式应用程序中的协作和同步需求
  - 它
- Nacos：
  - Nacos 则是为微服务架构设计的，除了服务注册和发现，还包括动态配置管理、流量管理、服务降级和熔断等功能。它更适合于微服务架构和云原生场景
  - Nacos 是一个全面的服务发现和配置管理平台，旨在简化微服务架构下的服务注册、发现和配置管理等能力，帮助开发人员构建弹性、可伸缩和容错的分布式系统

#### 6.2 支持的协议

- Zookeeper
  - Zookeeper 使用 ZAB（ Zookeeper Atomic Broadcast ）协议，它是一种基于原子广播的一致性协议
  - Zookeeper 整体遵循一致性（ CP ）原则，即在任何时候对 Zookeeper 的访问请求能得到一致的数据结果，但是当机器下线或者宕机时，不能保证服务可用性，因为选举需要花费一定时间（ 这在注册中心这个场景就很要命，注册中心可用性要求高于一致性 ）
- Nacos
  - Nacos 使用 RAFT 协议，它是一种具有强一致性保证的分布式一致性协议（ 支持 AP 也支持 CP ），相对于 ZAB 协议具有更强的一致性保证

#### 6.3 架构模式

- ZooKeeper：
  - ZooKeeper 采用主从架构，包括一组服务器构成的集合，其中一个为 Leader，其他为 Follower，并通过主从复制来实现数据的复制和高可用性
- Nacos：
  - Nacos 采用主从集群模式，节点根据不同的角色分为服务节点、配置节点和控制节点。每种角色的节点在集群中的功能和复制的数据是不同的

#### 6.4 功能特性

- ZooKeeper：
  - ZooKeeper 提供可靠的数据存储和监听功能，支持分布式锁、分布式队列、leader 选举等
- Nacos：
  - Nacos 不仅包含了服务注册和发现、配置管理等基础功能，还提供了流量管理、服务降级、熔断等服务治理能力，更适合于构建和管理微服务架构

#### 6.5 存储结构

- ZooKeeper
  - ZooKeeper 使用内存数据库存储数据
- Nacos
  - Nacos 使用 MySQL 或者 TiDB 存储数据

## 7. 常用 Nacos 实现包

- [nacos-sdk-nodejs](https://github.com/nacos-group/nacos-sdk-nodejs)
