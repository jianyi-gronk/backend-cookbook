## 1. 什么是 BigTable

- BigTable 是一个分布式存储系统，他可以支持 PB 级别的数据，包括几千个商业服务器
- Google 的许多项目都存储在 BigTable 上，包括 WEB 索引、Google Earth 和 Google Finance。这些应用对 BigTable 提出了截然不同的需求，无论是从数据量（ 从 URL 到网页到卫星图像 ）而言，还是从延迟需求（ 从后端批量处理到实时数据服务 ）而言。尽管有这些不同的需求，但 BigTable 已经为所有的 Google 产品提供了一个灵活的、高性能的解决方案
- 在许多方面，BigTable 都和数据库很相似，它具有和数据库相同的实施策略。并行数据库和内存数据库已经取得了可扩展性和高性能，但是 BigTable 提供了和这些系统不一样的接口
- BigTable 模式参数允许用户动态地控制，是从磁盘获得数据还是从内存获得数据

  <img src="https://img-blog.csdnimg.cn/direct/6c9cc981119f429ba13f43a049aad06b.png" width="500">

## 2. 数据模型

#### 2.1 基础介绍

- BigTable 是一个稀疏的、分布式的、持久化存储的多维排序 Map，不支持完整的关系型数据模型，相反，它为客户提供了一个简单数据模型
  - 该数据模型可以支持针对数据部署和格式的动态控制，并且可以允许用户去推理底层存储所展现的数据的位置属性（ 比如具有相同前缀 key 的数据位置很接近，读取时候可进行一定的预取来进行优化 ）
  - 该 Map 的索引是 行关键字，列关键字 以及 时间戳，行 和 列 名称可以是任意字符串
  - 该 Map 中的每个 value 都是一个未经解析的 byte 数组（ 也可以视为未经解释的字符串 ），用户可能经常把不同格式的结构化数据和非结构化数据都序列化成字符串
  - key -> value 可以表示为
    ```
    (row:string, column:string, time:int64) -> string
    ```
- 如图所示
  <img src="https://img-blog.csdnimg.cn/direct/abedd8a8f61a41018710e6a11421ed3c.png" width="500">
- 举例说明
  <img src="https://img-blog.csdnimg.cn/direct/996dcd2bc8b14e2c925346ccb3ef4c1a.png" width="500">
  - 假设有一个可能被很多项目都使用的、很大的网页集合以及相关的信息，这个特定的表为 Webtable
  - 在 Webtable 当中，行名称是反转的 URL，网页的不同方面作为列键，contents: 列家族包含了网页内容，anchor: 列家族包含了任何引用这个页面的 anchor 文本
  - CNN 的主页被 Sports Illustrated 和 MY-look 主页同时引用，因此,我们的行包含了名称为 "anchor:cnnsi.com" 和 "anchor:my.look.ca" 的列
  - 每个 anchor 单元格都只有一个版本，contents: 列有三个版本，分别对应于时间戳 t3, t5 和 t6
  - 可以用 ("com.cnn.www", "contents:", t5) 来找到 CNN 主页在 t5 时刻的内容

#### 2.2 行

- 表中的行关键字可以是任意的字符串（ 目前支持最大 64KB 的字符串，但是一般 10-100 个字节就够 ）
- 对同一个行关键字的读或者写操作都是 **原子** 的（ 不管读或者写这一行里多少个不同列 ），这个设计决策能够使用户很容易的理解程序在对同一个行进行并发更新操作时的行为
- 表中的每个行都可以 **动态分区**，每个分区叫做一个 “Tablet”，**Tablet 是数据分布和负载均衡调整的最小单位**，这样做的结果是，当操作只读取行中很少几列的数据时效率很高，通常只需要很少几次机器间的通信即可完成
- Bigtable 通过行关键字的 **字典顺序** 来组织数据
  - 用户可以通过选择合适的行关键字，在数据访问时有效利用数据的位置相关性，从而更好的利用这个顺序特性
  - 举例来说，在 Webtable 里，通过反转 URL 中主机名的方式，可以把同一个域名下的网页聚集起来组织成连续的行
  - 具体来说，我们可以把 maps\.google.com/index.html 的数据存放在关键字 com.google.maps/index.html 下，把相同的域中的网页存储在连续的区域可以让基于主机和域名的分析更加有效

#### 2.3 列

- 列关键字组成的集合叫做 “列族”，列族是访问控制的基本单位
- 存放在同一列族下的所有数据通常都属于同一个类型（ 可以把同一个列族下的数据压缩在一起 ）
- 列族在使用之前必须先创建，然后才能在列族中任何的列关键字下存放数据。列族创建后，其中的任何一个列关键字下都可以存放数据。根据我们的设计意图，一张表中的列族不能太多（ 最多几百个，但一张表可以有无限多个列 ），并且列族在运行期间很少改变
- 列关键字的命名语法如下：列族:限定词。列族的名字必须是可打印的字符串，而限定词的名字可以是任意的字符串
  - 比如，Webtable 有个列族 language，language 列族用来存放撰写网页的语言。我们在 language 列族中只使用一个列关键字，用来存放每个网页的语言标识 ID
  - Webtable 中另一个有用的列族是 anchor。这个列族的每一个列关键字代表一个锚链接，Anchor 列族的限定词是引用该网页的站点名，Anchor 列族每列的数据项存放的是链接文本
- 访问控制、磁盘和内存的使用统计都是在列族层面进行的
  - 在 Webtable 例子中，上述的控制权限能帮助我们管理不同类型的应用
  - 比如我们允许一些应用可以添加新的基本数据，一些应用可以读取基本数据并创建继承的列族，一些应用则只允许浏览数据，一些应用可能因为隐私的原因不能浏览所有数据

#### 2.4 时间戳

- 在 Bigtable 中，表的每一个数据项都可以包含同一份数据的不同版本，而不同版本的数据通过时间戳来索引
- Bigtable 的时间戳的类型是 64 位整型
  - Bigtable 会给时间戳赋值，用来表示精确到毫秒的 “实时” 时间
  - 用户程序也可以给时间戳赋值。如果应用程序需要避免数据版本冲突，那么它必须自己生成具有唯一性的时间戳
  - 数据项中，不同版本的数据按照时间戳倒序排序，即最新的数据排在最前面
- 为了减轻多个版本数据的管理负担，我们对每一个列族配有两个设置参数
  - Bigtable通过这两个参数可以对废弃版本的数据自动进行垃圾收集
  - 用户可以指定只保存最后 n 个版本的数据，或者只保存 “足够新” 的版本的数据（ 比如，只保存最近 7 天的内容写入的数据 ）
  - 在 Webtable 的举例里，contents: 列存储的时间戳信息是网络爬虫抓取一个页面的时间，上面提及的垃圾收集机制可以让它只保留最近三个版本的网页数据

## 3. 组件

#### 3.1 GFS

- BigTable 使用 Google 的分布式文件系统 GFS 存储日志文件和数据文件
- BigTable 集群通常运行在一个共享的机器池中，池中的机器还会运行其它的各种各样的分布式应用程序，BigTable 的进程经常要和其它应用的进程共享机器。BigTable 依赖集群管理系统来调度任务、管理共享的机器上的资源、处理机器的故障、以及监视机器的状态
- BigTable 内部存储数据的文件是 Google SSTable 格式的
  - SSTable 是一个持久化的、排序的、不可更改的 Map 结构，key 和 value 的值都是任意的 Byte 串（ 字符串 ）
  - 可以对 SSTable 进行如下的操作：
    - 查询与一个 key 值相关的 value
    - 遍历某个 key 值范围内的所有的 key-value 对
  - 从内部看，SSTable 是一系列的数据块（ 通常每个块的大小是 64 KB，这个大小是可以配置的 ）
    - SSTable 使用块索引（ 通常存储在 SSTable 的最后 ）来定位数据块
    - 在打开 SSTable 的时候，索引被加载到内存
    - 每次查找都可以通过一次磁盘搜索完成，首先使用二分查找法在内存中的索引里找到数据块的位置，然后再从硬盘读取相应的数据块
    - 当然也可以选择把整个 SSTable 都放在内存中，这样就不必访问硬盘了

#### 3.2 chubby

- BigTable 依赖一个高可用的、持久性的分布式锁服务 Chubby
- 1 个 Chubby 服务包含 5 个动态副本，其中一个被选作主副本对外提供服务
  - 当大部分副本处于运行状态并且能够彼此通信时，这个服务就是可用的
  - Chubby 使用 Paxos 算法来使它的副本在失败时保持一致性
- Chubby 提供了一个名字空间，它包含了目录和小文件
  - 每个目录和文件可以被用作一个锁，针对文件的读和写操作都是原子的
- Chubby 客户端函数库提供了针对 Chubby 文件的持久性缓存。每个 Chubby 客户端维护一个 session，这个 session 具备 Chubby 服务。如果租约过期以后不能及时更新 session 的租约，那么这个客户端的 session 就会过期。当一个客户端的 session 过期时，它会丢失所有锁，并且放弃句柄。Chubby 客户端也可以注册针对 Chubby 文件和目录的回调服务（ callback ），从而通知 session 过期或其他变化
- BigTable 使用 Chubby 来完成许多任务：
  - 保证在每个时间点只有一个主副本是活跃的
  - 来存储 BigTable 数据的自引导的位置
  - 来发现 tablet 服务器，包括 tablet 服务器加入和下线
  - 存储 BigTable 模式信息（ 即每个表的列家族信息 ）
  - 存储访问控制列表
- 如果在一段时间以后，Chubby 变得不可用，BigTable 就不可用了
- 我们最近对涵盖 11 个 Chubby 实例的 14 个 BigTable 簇进行了这方面的效果测试。由于 Chubby 的不可用（ 可能由于Chubby过时，或者网络故障 ），而导致一些存储在 BigTable 中的数据变得不可用，这种情形占到 BigTable 服务小时的平均比例值是 0.0047%。单个簇的百分比是 0.0326%
