## 1. SQL 语句

#### 基础介绍

- 几乎所有的关系型数据库系统都支持 SQL 语言，是高度非过程化；而非关系型数据模型的数据操作语言是面向过程的语言
- SQL 语言采用集合操作方式，其操作对象， 操作结果都是元组的集合；而非关系型数据库模型采用的是面向记录的操作方式，其操作对象是一条记录

#### 常见语法

- 数据查询：SELECT
- 数据定义：CREATE，DROP，ALTER
- 数据更新：INSERT，DELETE，UPDATE
- 数据控制：GRANT，REVOKE
- 常用函数：[参考](https://blog.csdn.net/sundna/article/details/89926586)

## 2. 单表查询

#### 基础概念

- SQL 语言支持关系数据库管理系统的三级模式结构，其中外模式对应试图和部分基本表，模式对应基本表，内模式对应存储文件，如下图所示
  <img src="https://img-blog.csdnimg.cn/634cb37df2f94eb784740a862063dce5.png" width="500px">

- 用户可以 SQL 语言可对基本表，视图和查询表进行操作
- 基本表：数据库中独立存在的表称为基本表。在 SQL 中一个关系对应一个基本表，一个（ 或多个 ）基本表对应一个存储文件；一个表可以带若干索引，索引也存放在存储文件中
- 视图：指从一个或几个基本表（ 或视图 ）中导出的表，是虚表，只存放视图的定义而不存放对应的数据
- 查询表：指查询结果对应的表
- 存储文件：指数据库中存放关系的物理文件，其逻辑结构组成了关系数据库的内模式，其物理结构对用户是透明的

#### 基本结构

- 查询语句主要语法
  ```
  SELECT ALL|DISTINCT A1, A2, ..., An
  FROM 表名
  WHERE 查询条件
  GROUP BY 分组字段
  HAVING 查询条件
  ORDER BY 排序字段 ASC|DESC
  ```
- SELECT 子句对应于关系代数中的投影运算，用来指定查询结果中所需要的属性或表达式，SELECT 子句中可以使用 属性，常数，函数 和 表达式
  - A1，A2，...，An 代表需要查找的属性或表达式
    - 可以通过 A1 as x，或者 A1 x 来给 A1 属性取别名 x
  - ALL 是默认关键字，返回所有记录；DISTINCT 是对查询结果中的重复元组进行去重
    - DISTINCT 和 ALL 只能放在开头，且只能对跟在它后面的字段名去重
    - 使用 DISTINCT 关键字会使查询效率下降（ 因为 DISTINCT 去除重复值之前，首先要对查询结果集进行排序操作，然后在删除每组第一条记录以外的其他记录 ），因此尽量避免使用它，在需要去除重复信息时尽量使用 GROUP BY 子句
  - 如果 SELECT 子句中有 函数 或者 表达式，则先计算 函数 或 表达式 的值，然后将计算的结果显示出来
    - 比如 lower(name)，把 name 这属性的值都改成小写
- FROM 子句对应于关系代数中的笛卡尔积，用来给出查询所涉及的表，表可以是基本表，视图或查询表
- WHERE 子句对应关系代数中的选择运算，用来指定查询结果元组所需要满足的选择条件
  - 常用的查询条件运算符如下
    - 比较运算：>，>=，<，<=，=，<>（ 或 != ）
    - 范围查询：BETWEEN 下限 AND 上限
    - 集合查询：IN ('v1', 'v2', ..., 'vn')
    - 空值查询：IS null
    - 字符匹配查询：LIKE
    - 逻辑查询：AND，OR，NOT
    - 存在量词查询：EXISTS
- HAVING 子句一定要与 GROUP BY 子句一起使用，用来实现分组运算
  - GROUP BY 子句对查询结果按某一列或某几列进行分组，值相等的分为一组
  - HAVING 子句类似 WHERE 子句，对分组的结果进行选择，仅输出满足条件的组
- ORDER BY 子句必须放在所有子句的后面，ASC 升序（ 默认 ），DESC 降序

#### 查询语句细节

- SELECT 每次子句执行完都会生产新的虚拟表，人们通常将最终的虚拟表称为查询结果集，具体子句的执行顺序为：
  1.  FROM 子句
  2.  WHERE 子句
  3.  GROUP BY 子句
  4.  HAVING 子句
  5.  SELECT 子句
  6.  ORDER BY 子句
- ON，WHERE 和 HAVING 子句的区别为：
  - ON 子句是在生成临时表之前就去作用的，它会在数据源那里就把不符合要求的数据给过滤掉，所以最早执行
  - WHERE 子句在 GROUP BY 分组和聚合函数之前对数据行进行过滤
  - HAVING 子句对 GROUP BY 分组和聚合函数之后的数据行进行过滤
- 聚合函数可以直接使用在 HAVING 或者 SELECT 后，但是不能写在 WHERE 子句后面
- SQL 语句不区分大小写，但是大部分人遵循一种规则，关键字大写，字段名和表名小写
- 多个子句可以一行也可以多行，多行更容易阅读和调试
- 大部分数据库管理系统不需要在子句后面加分号，只需要在结束时添加，但是有些事必须要加分号，例 Oracle

## 3. 多表查询

#### 等值连接

- 等值连接即在 WHERE 子句中，加入连接多个关系的连接条件，其格式例如 WHERE T1.x = T2.x
- 对于多个表中不同属性名，可以不要在属性名中加上表名
- 例如
  ```
  SELECT a.studentNo, studentName
  FROM Student a, Course b, Score c
  WHERE b.courseNo = c.courseNo AND c.studentNo = a.studentNo
  ```

#### 自然连接

- SQL 不直接支持自然连接，完成自然连接的方法是在等值连接的基础上消除重复列
- 例如，两个表格都存在 courseNo 这个属性，可以只使用 a.courseNo 或 b.courseNo
  ```
  SELECT studentNo, a.courseNo, score, courseName
  FROM Score a, Course b
  WHERE b.courseNo = c.courseNo
  ```

#### 自表连接

- 若某个表与自己进行连接，称为自表连接
- 例如，在学生表中查询和 cjy 在同一个班级的同学姓名和班级编号
  ```
  SELECT a.studentName, a.classNo
  FROM Student a, Student b
  WHERE b.studentName = 'cjy' AND a.classNo = b.classNo
  ```

#### 左外连接

- 一般连接中，只有满足连接条件的元组才能被检索出来
- 左外连接的连接结果中包含左关系中的所有元组，对于左关系中没有连接上的元组，其右关系中的相应属性用空值替代
- 语法为：FROM Table1 t1 LEFT OUTER JOIN Table2 t2 on t1\.no = t2\.no

#### 右外连接

- 一般连接中，只有满足连接条件的元组才能被检索出来
- 右外连接的连接结果中包含右关系中的所有元组，对于右关系中没有连接上的元组，其左关系中的相应属性用空值替代
- 语法为：FROM Table1 t1 RIGHT OUTER JOIN Table2 t2 on t1\.no = t2\.no

#### 全外连接

- 一般连接中，只有满足连接条件的元组才能被检索出来
- 全外连接的连接结果中包含左右关系中的所有元组，对于左关系中没有连接上的元组，其右关系中的相应属性用空值替代；对于右关系中没有连接上的元组，其左关系中的相应属性用空值替代
- 语法为：FROM Table1 t1 FULL OUTER JOIN Table2 t2 on t1.no = t2.no

## 4. 嵌套子查询

#### 基础介绍

- 在 SQL 查询中，一个 SELECT - FROM - WHERE 查询语句称为一个查询块，将一个查询块嵌入到另一个查询块的 WHERE 子句或 HAVING 子句中，称为嵌套子查询
- 虽然 SQL 语句允许多层嵌套子查询，但是在子查询中，不允许使用 ORDER BY 子句，该子句仅用于最后的输出结果排序
- SQL 语句提供的子查询可以将多个简单查询构造为一个非常复杂的查询，从而丰富和加强 SQL 的查询共能
- SQL 嵌套查询分为相关子查询和非相关子查询
  - 非相关子查询是指子查询的结果不依赖于上层查询
  - 相关子查询是指当上层查询的元组发生变化时，其子查询必须重新执行

#### 使用 IN 的子查询

- 由于 SELECT 语句的查询结果是一个元组的集合，因此可以嵌套 SELECT 语句到 IN 子句中
- 例如
  ```
  SELECT studentName
  FROM Student
  WHERE Student, studentNo IN (SELECT Score.studentNo FROM Score)
  ```

#### 使用比较运算符的子查询

- 在比较运算中，常常要用到谓词 ANY（ 或 SOME，和 ANY 相同作用 ）和 ALL
  - ANY 表示子查询结果中的任意值
  - ALL 表示子查询结果中的所有值
  - 如果子查询的结果关系中仅包含一个元组，则可以将比较运算符中的 ALL 和 ANY 去掉，直接使用比较符
  - 使用方法，例如
    - = ANY：等于子查询结果中的任意值
    - \> ANY：大于子查询结果中的任意值
    - < ALL：小于子查询结果中的所有值
- 例如
  ```
  SELECT studentNo, courseNo, score
  FROM Score
  WHERE score > ALL(SELECT score FROM Score WHERE courseNo = '002')
  ```
- 例如
  ```
  SELECT studentNo, courseNo, score
  FROM Score
  WHERE score = (SELECT max(score) FROM Score)
  ```

#### 使用存在量词 EXISTS 的子查询

- EXISTS 用来判断其后的子查询的结果集合中是否存在元素，它会返回 true 或 false
- 例如
  ```
  SELECT studentName, classNo
  FROM Student x
  WHERE EXISTS(select * from Student WHERE studentNo = '001')
  ```

#### 复杂子查询

- 例如
  ```
  SELECT studentNo
  FROM Course x, (SELECT student ...)
  ```

## 5. 集合运算

- SQL 支持集合运算，多个 SELECT 语句的结果可以进行集合操作，传统的集合操作主要包括：
  - 并 UNION
  - 交 INTERSECT
  - 差 EXCEPT
- 在执行集合运算时，要求参与运算的查询结果的列数一样，其对应列的数据类型必须一致
- SQL Server 数据库不支持交运算和差运算，这两个完全可以用其他运算替代
- 例如
  ```
  SELECT studentNo, birthday, className, institute
  FROM Student a, Class b
  WHERE a.classNo = b.classNo AND year(birthday) = 1999
  UNION
  SELECT studentNo, birthday, className, institute
  FROM Student a, Class b
  WHERE a.classNo = b.classNo AND year(birthday) = 1998
  ```
