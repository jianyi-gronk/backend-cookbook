## 1. 常见分布式理论 —— CAP 理论

- CAP 定理（ Consistency、Availability、Partition Tolerance Theorem ），也称为 Brewer 定理，起源于在 2000 年 7 月，是加州大学伯克利分校的 Eric Brewer 教授于 “ACM 分布式计算原理研讨会（ PODC ）” 上提出的一个猜想
  ![image](https://github.com/user-attachments/assets/a812987f-ab6d-467a-88a4-6cc2bb6fba2f)
- 两年之后，麻省理工学院的 Seth Gilbert 和 Nancy Lynch 以严谨的数学推理证明了 CAP 猜想。自此，CAP 正式从猜想变为分布式计算领域所公认的著名定理

#### 1.1 C，A，P

- 一致性（ Consistency，C ）
  - 指强一致性，分布式系统中的所有节点在同一时刻具有同样的值、都是最新的数据副本，一致性保证了不管向哪台服务器写入数据，其他的服务器能实时同步数据
  - 一致性在分布式研究中是有严肃定义、有多种细分类型的概念。分布式共识算法中，那种面向副本复制的一致性与这里面向数据库状态的一致性严格来说并不完全等同，具体差别我们将在后续分布式共识算法中再作探讨
- 可用性（ Availability，A ）
  - 部分结点宕机不影响整个集群对外提供服务，每次向未故障的节点发送请求，服务节点总能保证在有限的时间内处理完成并进行响应，从用户角度来看就是不会出现系统操作失败或者访问超时等问题，但是系统内部可能会出现网络延迟等问题
  - 理解可用性要先理解与其密切相关两个指标：可靠性（ Reliability ）和可维护性（ Serviceability ）
    - 可靠性使用平均无故障时间（ Mean Time Between Failure，MTBF ）来度量
    - 可维护性使用平均可修复时间（ Mean Time To Repair，MTTR ）来度量
  - 可用性衡量系统可以正常使用的时间与总时间之比，其表征为：A = MTBF/（ MTBF + MTTR ），即可用性是由可靠性和可维护性计算得出的比例值，譬如 99.9999% 可用，即代表平均年故障修复时间为 32 秒
- 分区容错性（ Partition Tolerance，P ）
  - 由于网络的问题错综复杂，如果某个节点因为网络等问题造成数据不一致，或者数据延迟很久才同步过来，虽然会影响部分节点数据的时效性，但是服务节点依然是可用的，分布式系统要能容忍这种情况的，也就是说，尽管网络上有部分消息丢失，但系统仍然可继续工作

#### 1.2 CAP 理论

- CAP 理论：
  - **CAP 定理描述了一个分布式的系统中，涉及共享数据问题时，CAP 是无法同时满足的，只能满足 CAP 中的两种，因此在设计分布式架构时，必须做出取舍**
  - 而对于分布式系统，分区容忍性是基本要求，必须要满足，否则就失去了价值
  - 因为节点宕机和网络故障是大概率事件，很难避免，而当出现这种情况时，不可能同时保持一致性和可用性，所以设计分布式系统，就是在一致性和可用性之间取一个平衡
- CAP 理论侧重于在面对分区时进行权衡，关注在分布式系统中，在网络分区的情况下，一致性和可用性之间的取舍

#### 1.3 场景举例

- 单纯只列概念，CAP 是比较抽象的，以下面所列的场景事例来说明这三种特性对分布式系统来说将意味着什么
- 假设 Fenix's Bookstore 的服务拓扑如下图所示，一个来自最终用户的交易请求，将交由账号、商家和仓库服务集群中某一个节点来完成响应：
  ![image](https://github.com/user-attachments/assets/e8bd7e89-f8a9-4246-ba77-5a7786a3460e)
- 在这套系统中，每一个单独的服务节点都有自己的数据库（ 这里是为了便于说明问题的假设，在实际生产系统中，一般应避免将用户余额这样的数据设计成存储在多个可写的数据库中 ），假设某次交易请求分别由 “账号节点 1”、“商家节点 2”、“仓库节点 N” 联合进行响应
- 当用户购买一件价值 100 元的商品后，账号节点 1 首先应给该用户账号扣减 100 元货款，它在自己数据库扣减 100 元很容易，但它还要把这次交易变动告知本集群的节点 2 到节点 N，并要确保能正确变更商家和仓库集群其他账号节点中的关联数据，此时将面临以下可能的情况
  - 如果该变动信息没有及时同步给其他账号节点，将导致有可能发生用户购买另一商品时，被分配给到另一个节点处理，由于看到账号上有不正确的余额而错误地发生了原本无法进行的交易，此为一致性问题
  - 如果由于要把该变动信息同步给其他账号节点，必须暂时停止对该用户的交易服务，直至数据同步一致后再重新恢复，将可能导致用户在下一次购买商品时，因系统暂时无法提供服务而被拒绝交易，此为可用性问题
  - 如果由于账号服务集群中某一部分节点，因出现网络问题，无法正常与另一部分节点交换账号变动信息，此时服务集群中无论哪一部分节点对外提供的服务都可能是不正确的，整个集群能否承受由于部分节点之间的连接中断而仍然能够正确地提供服务，此为分区容忍性
- 以上还仅仅涉及了账号服务集群自身的 CAP 问题，对于整个 Fenix's Bookstore 站点来说，它更是面临着来自于账号、商家和仓库服务集群带来的 CAP 问题，譬如，用户账号扣款后，由于未及时通知仓库服务中的全部节点，导致另一次交易中看到仓库里有不正确的库存数据而发生超售。又譬如因涉及仓库中某个商品的交易正在进行，为了同步用户、商家和仓库的交易变动，而暂时锁定该商品的交易服务，导致了的可用性问题，等等

#### 1.4 如何选择

- 如果放弃分区容忍性（ CA without P ）
  - 意味着我们将假设节点之间通信永远是可靠的。永远可靠的通信在分布式系统中必定不成立的，这不是你想不想的问题，而是只要用到网络来共享数据，分区现象就会始终存在
  - 在现实中，最容易找到放弃分区容忍性的例子便是传统的关系数据库集群，这样的集群虽然依然采用由网络连接的多个节点来协同工作，但数据却不是通过网络来实现共享的。以 Oracle 的 RAC 集群为例，它的每一个节点均有自己独立的 SGA、重做日志、回滚日志等部件，但各个节点是通过共享存储中的同一份数据文件和控制文件来获取数据的，通过共享磁盘的方式来避免出现网络分区
  - 因而 Oracle RAC 虽然也是由多个实例组成的数据库，但它并不能称作是分布式数据库。
- 如果放弃可用性（ CP without A ）
  - 意味着我们将假设一旦网络发生分区，节点之间的信息同步时间可以无限制地延长，此时，问题相当于退化到前面 “全局事务” 中讨论的一个系统使用多个数据源的场景之中，我们可以通过 2PC/3PC 等手段，同时获得分区容忍性和一致性
  - 在现实中，选择放弃可用性的 CP 系统情况一般用于对数据质量要求很高的场合中，除了 DTP 模型的分布式数据库事务外，著名的 HBase 也是属于 CP 系统，以 HBase 集群为例，假如某个 RegionServer 宕机了，这个 RegionServer 持有的所有键值范围都将离线，直到数据恢复过程完成为止，这个过程要消耗的时间是无法预先估计的
- 如果放弃一致性（ AP without C ）
  - 意味着我们将假设一旦发生分区，节点之间所提供的数据可能不一致
  - 选择放弃一致性的 AP 系统目前是设计分布式系统的主流选择，因为 P 是分布式网络的天然属性，你再不想要也无法丢弃；而 A 通常是建设分布式的目的，如果可用性随着节点数量增加反而降低的话，很多分布式系统可能就失去了存在的价值，除非银行、证券这些涉及金钱交易的服务，宁可中断也不能出错，否则多数系统是不能容忍节点越多可用性反而越低的
  - 目前大多数 NoSQL 库和支持分布式的缓存框架都是 AP 系统，以 Redis 集群为例，如果某个 Redis 节点出现网络分区，那仍不妨碍各个节点以自己本地存储的数据对外提供缓存服务，但这时有可能出现请求分配到不同节点时返回给客户端的是不一致的数据

#### 1.5 为什么在 P 满足的情况下，CA 不能同时满足呢

- 假设现在要求满足 C（ 一致性 ），那么就是说所有的节点在某一刻提供的数据都必须一致，然而在 P 的情况，是不可能保证的，要保证的话，就只能把其他节点全部干掉，比如禁止读写，那这其实就是和 A 是相悖的（ 某些节点虽然延迟，但是节点本身可用 ）
- 假设现在要求满足 A（ 可用性 ），那么就是说只要节点本身没什么问题，就可以对外提供服务，哪怕有点数据延迟，很明显这肯定是和 C 相悖的

## 2. 常见分布式理论 —— BASE 理论

- 最终一致性的概念是 eBay 的系统架构师 Dan Pritchett 在 2008 年在 ACM 发表的论文《Base: An Acid Alternative》中提出的，该论文总结了一种独立于 ACID 获得的强一致性之外的、使用 BASE 来达成一致性目的的途径，并系统性地总结了一种针对分布式事务的技术手段

#### 2.1 基础介绍

- BASE 理论侧重于分布式系统的设计思想，关注的是可用性和性能，并容忍暂时的数据不一致性，强调最终一致性
- BASE 分别是基本可用性（ Basically Available ）、柔性事务（ Soft State ）和最终一致性（ Eventually Consistent ）的缩写
- 基本可用性
  - 基本可用是指分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用
  - 电商大促时，为了应对访问量激增，部分用户可能会被引导到降级页面，服务层也可能只提供降级服务。这就是损失部分可用性的体现
- 软状态
  - 软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时 就是软状态的体现。mysql replication 的异步复制也是一种体现
- 最终一致性
  - 最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态

#### 2.2 BASE 和 ACID

- BASE 理论是对传统 ACID 事务模型的一种补充和扩展，强调在分布式系统中可用性和性能的重要性
- BASE 核心思想是即使无法做到强一致性，但每个业务根据自身的特点，采用适当的方式来使系统达到最终一致性
- 很多时候我们并不要求数据的强一致性，而 BASE 通过牺牲强一致性来获得更好的可用性，所以 BASE 理论的适用性更广泛，比如更适合面向的是大型高可用可扩展的分布式系统

#### 2.3 BASE 和 CAP

- BASE 理论是在 CAP 的理论基础上做了进一步的延伸
- CAP 只告诉了我们什么可以，什么不可以，但是 BASE 则是更具体的告诉我们具体应该从哪些方面去做
- 它的核心思想是，我们尽全力保证系统的可用性（ AP ），为实现这个目标，在对应的场景中，我们设计一些软状态、牺牲一些非核心功能的可用性来保障核心功能的正常、允许一段时间的数据的不一致性，而只需要保证数据的最终一致性
