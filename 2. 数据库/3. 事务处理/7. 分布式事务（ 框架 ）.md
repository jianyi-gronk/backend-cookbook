## 1. Seata 分布式事务解决方案（ [详情](https://www.zhihu.com/tardis/bd/art/437577902?source_id=1001) ）

#### 1.1 基础介绍

- Seata 是由阿里巴巴开源的一款分布式事务解决方案。其目的是解决在微服务架构中的分布式事务问题，通过提供高效可靠的分布式事务管理能力，帮助开发者实现分布式系统中的数据一致性和可靠性
- Seata 支持多种事务模式，包括 XA、AT、TCC 和 SAGA。开发者可以根据业务需求选择合适的模式，Seata 会根据所选模式来协调和管理分布式事务的一致性
  - XA 模式：基于 X/Open XA 协议，将多个数据库的本地事务协调成全局事务，实现分布式事务的一致性
  - TCC 模式：使用 Try-Confirm-Cancel 三个阶段将业务操作拆分成多个本地事务，并实现最终一致性
  - AT 模式：是 Seata 的默认模式，通过自动补偿机制实现分布式事务的一致性，适用于一些不支持 XA 协议的数据库
  - SAGA 模式：使用 Saga 模式实现分布式事务，适合长事务模式，将业务操作拆分为多个子事务，通过补偿来保证最终一致性

#### 1.2 相关事务概念

- 分支事务（ 本地事务 ）：本地事务由本地资源管理器（ 通常指数据库管理系统 DBMS，例如 MySQL、Oracle 等 ）管理，严格地支持 ACID 特性，高效可靠。本地事务不具备分布式事务的处理能力，隔离的最小单位受限于资源管理器，即本地事务只能对自己数据库的操作进行控制，对于其他数据库的操作则无能为力
- 全局事务：全局事务指的是一次性操作多个资源管理器完成的事务，由一组分支事务（ 本地事务 ）组成

#### 1.3 核心概念

- Seata 对分布式事务的协调和控制，主要是通过 XID 和 3 个核心组件实现的
- XID
  - XID 是全局事务的唯一标识，它可以在服务的调用链路中传递，绑定到服务的事务上下文中
- 核心组件
  - Seata 的核心组件可分为 Seata 服务端和 Seata 客户端两类
  - Seata 定义了 3 个核心组件：
    - TC（ Transaction Coordinator ）：事务协调器，直接调度事务参与者 RM。负责将 RM 的反馈结果响应给 TM，并听从 TM 的最终决议，将具体决议（ 提交或回滚 ）发送给 RM 执行。相当于中间人，主要负责维护全局事务和分支事务的状态
    - TM（ Transaction Manager ）：事务管理器，它是事务的发起者（ 具体的微服务 ）。根据 RM 第一阶段的执行结果，进行决议。并将决议反馈给 TC，相当于发号施令的
    - RM（ Resource Manager ）：资源管理器，其实就是事务的参与者。获取 TC 的执行命令具去执行分支事务的第一阶段以及第二阶段，并将执行结果反馈给 TC，相当于具体做事的
    - 以上三个组件相互协作，TC 以 Seata 服务器（ Server ）形式独立部署，TM 和 RM 则是以 Seata Client 的形式集成在微服务中运行

#### 1.4 具体工作流程

![image](https://img-blog.csdnimg.cn/289150bc2a7f4b2fb940e8a361473963.png)
![image](https://img-blog.csdnimg.cn/91ce701dbd8e42eba69d69da7b29952c.png)

1. TM 向 TC 申请开启一个全局事务，全局事务创建成功后，TC 会针对这个全局事务生成一个全局唯一的 XID（此时，由 TM 发起的全局事务已经开启）
2. XID 通过服务的调用链传递到其他服务
3. RM 向 TC 注册一个分支事务，并将其纳入 XID 对应全局事务的管辖（事务参与者执行本地事务，此时分支事务已经执行完成，并反馈给 TC 执行结果。可以理解为 AT 模式下的第一个阶段）
4. TM 根据 TC 收集的各个分支事务的执行结果，向 TC 发起全局事务提交或回滚决议（事务协调者根据事务管理者的决议，发送提交或回滚的调度命令，可以理解为 AT 模式下的第二阶段）
5. TC 调度 XID 下管辖的所有分支事务完成提交或回滚操作

## 2. XA，AT，TCC，SAGA 的区别

- XA 是强一致性的分布式事务协议，而 AT、TCC 和 SAGA 则是最终一致性的分布式事务模型，原因是：
  - XA 在第一阶段，并不会提交事务，而只是写入日志，如果都没问题，才会在第二或第三阶段提交事务
  - AT、TCC 和 SAGA 在第一阶段中，都直接提交了事务，如果执行过程中发生问题，都是通过补偿机制来进行回滚
- XA，AT 不会存在代码侵入，而 TCC，SAGA 会造成代码侵入
  - XA 和 AT 在实施上更多地依赖于底层数据库或消息中间件的支持，而不需要显式地在应用程序代码中进行特定的编程
  - TCC 和 SAGA 需要开发人员手动定义每个步骤的操作、确认和取消逻辑，以及步骤之间的补偿机制，并将其显式地融入应用程序逻辑中
- XA，AT，TCC，SAGA 的核心不同分别是 日志，快照，预留，异步消息驱动：
  - XA 的核心是日志，通过事务日志记录参与者（ RM ）的操作，以实现事务的原子性和持久性
  - AT 的核心是快照，通过记录操作之前和操作之后的数据快照信息，以实现事务的原子性
  - TCC 的核心是预留，将一个业务操作分解为三个阶段：Try、Confirm 和 Cancel，通过预留资源和撤销操作来保证事务的一致性
  - SAGA 的核心是异步消息驱动，将长时间复杂的业务流程拆解为一系列离散的、相互关联的事务步骤。每个步骤都被视为一个独立的事务，并通过发送异步消息来驱动不同步骤之间的协调和处理
- 表格如下
  ![image](https://img-blog.csdnimg.cn/33bb1a9c5db54e92af117c0688e6c7e1.png)
