## 1. 使用样例（ Docker 运行 Node.js 项目 ）

#### 1.1 安装 Docker

- 首先，需要在计算机上安装 Docker。访问 [Docker 官方网站](https://www.docker.com/get-started)，选择适合操作系统的 Docker Desktop 版本（ Windows、macOS 或 Linux ）。按照安装向导的指示完成安装。安装完成后，启动 Docker 并确保它正在运行

#### 1.2 创建一个 Node.js 项目

- 创建一个新文件夹，例如 my-nodejs-app
- 接下来，在项目文件夹中创建一个名为 app.js 的文件，并添加以下代码到 app.js 中

  ```
  // 是一个简单的 Express.js 应用程序，它在端口 3000 上运行并在根目录中显示 "Hello World!" 消息
  const express = require('express');
  const app = express();
  const port = 3000;

  app.get('/', (req, res) => {
    res.send('Hello World!');
  });

  app.listen(port, () => {
    console.log(`Example app listening at http://localhost:${port}`);
  });
  ```

- 在项目根目录中创建 package.json 文件来管理项目的依赖项和元数据，并添加以下内容
  ```
  {
    "name": "my-nodejs-app",
    "version": "1.0.0",
    "description": "A simple Node.js app using Docker",
    "main": "app.js",
    "scripts": {
      "start": "node app.js"
    },
    "dependencies": {
      "express": "^4.17.1"
    }
  }
  ```
- 安装项目依赖项

  ```
  npm install
  ```

#### 1.3 创建 Dockerfile

- 在项目根目录中创建一个名为 Dockerfile 的文件（ 无扩展名 ）。这个文件将指导 Docker 如何构建 Node.js 应用程序的镜像
- 将以下内容添加到 Dockerfile

  ```
  # 使用官方 Node.js 镜像（基于 Node.js 14）
  FROM node:14

  # 设置工作目录为 /usr/src/app
  WORKDIR /usr/src/app

  # 将 package.json 和 package-lock.json 文件复制到工作目录
  COPY package*.json ./

  # 运行 npm install 安装依赖项
  RUN npm install

  # 将项目的其他文件复制到工作目录
  COPY . .

  # 暴露端口 3000
  EXPOSE 3000

  # 使用 node app.js 命令启动应用程序
  CMD ["node", "app.js"]
  ```

#### 1.4 构建 Docker 镜像

- 在项目根目录中打开终端，运行以下命令来构建 Docker 镜像，镜像指创建一个包含应用程序及其运行环境的轻量级、可移植的容器
- Docker 镜像是由一系列的层组成，每个层代表一个指令。这些层可以被缓存和复用，以减少构建和部署的时间
  ```
  // 这将根据 Dockerfile 构建一个名为 my-nodejs-app 的 Docker 镜像
  // 命令末尾的点号，表示使用当前目录下的 Dockerfile
  docker build -t my-nodejs-app .
  ```

#### 1.5 运行 Docker 容器

- 运行一个 Docker 容器来部署 Node.js 应用程序。使用以下命令运行 Docker 容器
  ```
  // 这将启动一个名为 my-nodejs-app-container 的 Docker 容器
  // 并将宿主机的端口 3000 映射到容器的端口 3000
  docker run -p 3000:3000 --name my-nodejs-app-container my-nodejs-app
  ```

#### 1.6 访问 Node.js 应用程序

- 打开 Web 浏览器，访问 http://localhost:3000，应该看到 "Hello World!" 消息

#### 1.7 停止 Docker 容器

- 在终端中按 Ctrl + C

#### 1.8 删除 Docker 容器

- 删除容器
  ```
  docker rm my-nodejs-app-container
  ```

## 2. Docker 间通信方法

#### 2.1 通过容器 ip 访问

- 容器重启后，ip 会发生变化，所以通过容器 ip 访问不是一个好的方案

#### 2.2 通过宿主机的 ip:port 访问

- 通过宿主机的 ip:port 访问，只能依靠监听在暴露出的端口的进程来进行有限的通信
- 容器之间通信不能用 localhost、127.0.0.1，只能用宿主机的 ip:port 通信，但是主机的 ip 地址可能会随着宿主机的重启而变化
- 以 MySQL 容器为例如下：
  - 创建容器
    ```bash
    docker run -it -p 3306:3306 --name mysql -e MYSQL_ROOT_PASSWORD=root mysql:5.7
    ```
- 暴露端口的方式很方便主机与容器之间的通信，跟连接主机本地一样
  ![image](https://github.com/user-attachments/assets/ef03cfd6-fc27-44bf-a71b-84720bf9ce41)

#### 2.3 通过 link 建立连接（ 官方已不推荐使用 ）

- 运行容器时，指定参数 link，使得源容器与被链接的容器可以进行相互通信，并且接受的容器可以获得源容器的一些数据，比如：环境变量
  ```bash
  # 源容器：mysql
  docker run -itd --name mysql_test -e MYSQL_ROOT_PASSWORD=root mysql:5.7
  # 被链接容器 ubuntu
  docker run -itd --name ubuntu_test --link test-mysql:mysql  ubuntu /bin/bash
  # 进入test-ubuntu
  docker exec -it ubuntu_test /bin/bash
  ```

#### 2.4 通过 User-defined networks（ 推荐 ）

- 通过用户自定义网络，加入了这个网络的容器可以互相联通，通过容器名称即可互相访问，相当于在同一个局域网
- 推荐新建的容器 -p 和 --network 都配置
  - 配置 -p 选项让宿主机和容器之间通过 暴露端口 来通信
  - 配置 --network 选项让容器加入同一个网络，加入同一个网络后就可通过容器名称来通信
- 以 centos 和 mysql 容器之间通信为例：
  - 创建网络
    ```
    docker network create dockerbetweennetwork
    ```
    - docker network 来创建一个桥接网络，在 docker run 的时候将容器指定到新创建的桥接网络中，这样同一桥接网络中的容器就可以通过互相访问
  - 启动 mysql 容器时，加入创建的网络
    ```
    # 创建mysql容器
    docker run -p 3306:3306 --name mysql \
    --network dockerbetweennetwork \
    -e MYSQL_ROOT_PASSWORD=root \
    -d mysql:5.7
    ```
    - 创建 mysql 容器加入到 dockerbetweennetwork 网络，也暴露了 3306 端口给主机使用
  - 启动 centos 容器时，加入创建的网络
    ```
    # 创建centos容器
    docker run -it --name centos \
    --network dockerbetweennetwork \
    --rm centos /bin/bash
    ```
    - centos 这种服务器性质的 docker 容器必须跟上命令，不然会默认退出
  - 查看 mysql 容器的 ip 地址
    ```
    # 查看mysql容器ip地址
    docker inspect mysql
    ```
    ![image](https://github.com/user-attachments/assets/bf50a9f3-f026-4800-9b5e-fcc244039139)
  - 进入 centos 容器连接 mysql，测试是否可以通过容器名称 ping 通 mysql 容器
    ```
    # 进入centos容器中
    docker exec -it centos /bin/bash
    # ping 上面得到的mysql容器的地址
    ping mysql
    ```
    ![image](https://github.com/user-attachments/assets/ab7a68b0-bdfd-4121-9a21-bb3ccee4dd0d)
