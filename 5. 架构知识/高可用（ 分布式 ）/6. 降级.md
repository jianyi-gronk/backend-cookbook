## 1. 熔断与降级

- 在高并发环境下，服务之间的依赖关系导致调用失败，解决的方式通常是: 限流 -> 熔断 -> 隔离 -> 降级, 其目的是防止雪崩效应
- 当用户请求 A、P、H、I 四个服务获取数据时，在正常流量下系统稳定运行，如果某天系统进来大量流量，其中服务 I 出现 CPU、内存占用过高等问题，结果导致服务 I 出现延迟、响应过慢，随着请求的持续增加，服务 I 承受不住压力导致内部错误或资源耗尽，一直不响应，此时更糟糕的是其他服务对 I 有依赖，那么这些依赖 I 的服务一直等待 I 的响应，也会出现请求堆积、资源占用，慢慢扩散到所有微服务，引发雪崩效应
  ![image](https://github.com/user-attachments/assets/e2e5795f-35b0-423e-ae0e-9c4cf63f24ed)
- 常见的容错模式主要包含以下几种方式
  ![image](https://github.com/user-attachments/assets/915758ca-5d5e-47ec-bd9b-8cd60c5aa3f4)
  - 主动超时：Http 请求主动设置一个超时时间，超时就直接返回，不会造成服务堆积
  - 限流：限制最大并发数
  - 熔断：当错误数超过阈值时快速失败，不调用后端服务，同时隔一定时间放几个请求去重试后端服务是否能正常调用，如果成功则关闭熔断状态，失败则继续快速失败，直接返回（ 此处有个重试，重试就是弹性恢复的能力 ）
  - 隔离：把每个依赖或调用的服务都隔离开来，防止级联失败引起整体服务不可用
  - 降级：服务失败或异常后，返回指定的默认信息

## 2. 服务降级

- 由于爆炸性的流量冲击，对一些服务进行有策略的放弃，以此缓解系统压力，保证目前主要业务的正常运行。它主要是针对非正常情况下的应急服务措施：当此时一些业务服务无法执行时，给出一个统一的返回结果
- 原因：整体负荷超出整体负载承受能力
- 目的：保证重要或基本服务正常运行，非重要服务延迟使用或暂停使用
- 大小：降低服务粒度，要考虑整体模块粒度的大小，将粒度控制在合适的范围内
- 可控性：在服务粒度大小的基础上增加服务的可控性，后台服务开关的功能是一项必要配置（ 单机可配置文件，其他可领用数据库和缓存 ），可分为手动控制和自动控制
- 次序：一般从外围延伸服务开始降级，需要有一定的配置项，重要性低的优先降级，比如可以分组设置等级 1-10，当服务需要降级到某一个级别时，进行相关配置

#### 2.1 降级方式

- 延迟服务：比如发表了评论，重要服务，比如在文章中显示正常，但是延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行
- 在粒度范围内关闭服务（ 片段降级或服务功能降级 ）：比如关闭相关文章的推荐，直接关闭推荐区
- 页面异步请求降级：比如商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，可以进行降级
- 页面跳转（ 页面降级 ）：比如可以有相关文章推荐，但是更多的页面则直接跳转到某一个地址
- 写降级：比如秒杀抢购，我们可以只进行 Cache 的更新，然后异步同步扣减库存到 DB，保证最终一致性即可，此时可以将 DB 降级为 Cache
- 读降级：比如多级缓存模式，如果后端服务有问题，可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景

#### 2.2 降级预案

- 在进行降级之前要对系统进行梳理，看看系统是不是可以丢卒保帅；从而梳理出哪些必须誓死保护，哪些可降级；比如可以参考日志级别设置预案：
  - 一般：比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级
  - 警告：有些服务在一段时间内成功率有波动（如在 95~100%之间），可以自动降级或人工降级，并发送告警
  - 错误：比如可用率低于 90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阀值，此时可以根据情况自动降级或者人工降级
  - 严重错误：比如因为特殊原因数据错误了，此时需要紧急人工降级

#### 2.3 服务降级分类

- 降级按照是否自动化可分为：自动开关降级（ 超时、失败次数、故障、限流 ）和人工开关降级（ 秒杀、电商大促等 ）
- 降级按照功能可分为：读服务降级、写服务降级
- 降级按照处于的系统层次可分为：多级降级

#### 2.4 自动降级分类

- 超时降级：主要配置好超时时间和超时重试次数和机制，并使用异步机制探测回复情况
- 失败次数降级：主要是一些不稳定的 api，当失败调用次数达到一定阀值自动降级，同样要使用异步机制探测回复情况
- 故障降级：比如要调用的远程服务挂掉了（ 网络故障、DNS 故障、http 服务返回错误的状态码、rpc 服务抛出异常 ），则可以直接降级。降级后的处理方案有：默认值（ 比如库存服务挂了，返回默认现货 ）、兜底数据（ 比如广告挂了，返回提前准备好的一些静态页面 ）、缓存（ 之前暂存的一些缓存数据 ）
- 限流降级: 当我们去秒杀或者抢购一些限购商品时，此时可能会因为访问量太大而导致系统崩溃，此时开发者会使用限流来进行限制访问量，当达到限流阀值，后续请求会被降级；降级后的处理方案可以是：排队页面（ 将用户导流到排队页面等一会重试 ）、无货（ 直接告知用户没货了 ）、错误页（ 如活动太火爆了，稍后重试 ）

#### 2.5 服务降级需考虑的问题

- 核心服务或非核心服务
- 是否支持降级，及其降级策略
- 业务放通场景，极其策略

## 3. 服务熔断与服务降级比较

- 服务熔断对服务提供了 proxy，防止服务不可能时，出现串联故障（ cascading failure ），导致雪崩效应
- 服务熔断一般是某个服务（ 下游服务 ）故障引起，而服务降级一般是从整体负荷考虑
- 共性：
  - 目的：都是从可用性、可靠性出发，提高系统的容错能力
  - 最终表现：使某一些应用不可达或不可用，来保证整体系统稳定
  - 粒度：一般都是服务级别，但也有细粒度的层面，如做到数据持久层、只许查询不许增删改等
  - 自治：对其自治性要求很高。都要求具有较高的自动处理机制
- 区别：
  - 触发原因：服务熔断通常是下级服务故障引起；服务降级通常为整体系统而考虑
  - 管理目标：熔断是每个微服务都需要的，是一个框架级的处理；而服务降级一般是关注业务，对业务进行考虑，抓住业务的层级，从而决定在哪一层上进行处理：比如在 IO 层，业务逻辑层，还是在外围进行处理
  - 实现方式：代码实现中的差异
